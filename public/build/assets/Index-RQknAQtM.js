import{d as z,g as ce,r as x,q as S,o as i,w as s,a,u as o,b as r,f as d,t as u,c as g,k as h,x as ue,E as de,A as F,D as ge,h as me,n as D,j as pe,v as fe,F as v,m as J,s as X}from"./app-BuS22ihf.js";import{_ as ye}from"./AppLayout.vue_vue_type_script_setup_true_lang-t7Xl4CSp.js";import{_ as I}from"./index-DgCd7pt8.js";import{_ as P,c as R,a as M,b as A}from"./CardTitle.vue_vue_type_script_setup_true_lang-Cj4mG78p.js";import{_ as W}from"./CardDescription.vue_vue_type_script_setup_true_lang-DT28TY8U.js";import{a as be,b as _e,c as ve,_ as he}from"./DialogTitle.vue_vue_type_script_setup_true_lang-1Tf4FU4v.js";import{_ as ke}from"./DialogDescription.vue_vue_type_script_setup_true_lang-tEIrpD2r.js";import{_ as xe}from"./Input.vue_vue_type_script_setup_true_lang-CrOkjhoL.js";import{_ as we}from"./Label.vue_vue_type_script_setup_true_lang-BG7ZKbVs.js";import{C as q}from"./lock-CSZOJ4UE.js";import{e as Ce,f as Ee}from"./useClientStore-D_XRFZaQ.js";import{C as T}from"./check-DxWXskU-.js";import"./AppSidebarLayout.vue_vue_type_script_setup_true_lang-itaSAdRo.js";import"./useForwardExpose-BeYjDCvQ.js";import"./Presence-CYl0QjyX.js";import"./x-D3wkYHd9.js";import"./createLucideIcon-BxBRfmdg.js";import"./VisuallyHidden-CyL5D56_.js";import"./index-CMWG4mbA.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-BucQAsJj.js";import"./globe-DC9fhOry.js";import"./loader-circle-B_z_EUvk.js";const Se={class:"space-y-4 py-4"},Fe={class:"space-y-2"},Pe={key:0,class:"text-sm text-red-600"},Re={class:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3"},Ie={class:"text-sm text-blue-600 dark:text-blue-400 mt-1 list-disc list-inside"},$e={class:"flex items-center gap-2"},De=z({__name:"CompanyCreationModal",props:{open:{type:Boolean},targetPlan:{}},emits:["close","success"],setup(V,{emit:f}){const L=V,p=f,y=ce({company_name:"",target_plan:L.targetPlan}),b=x(!1),k=()=>{y.company_name.trim()&&(b.value=!0,y.target_plan=L.targetPlan,y.post("/subscription/create-company-and-upgrade",{onSuccess:c=>{const m=c.props.flash;m?.redirect_url?window.location.href=m.redirect_url:(p("success",c.props.company),p("close"))},onError:c=>{console.error("Company creation failed:",c)},onFinish:()=>{b.value=!1}}))},C=()=>{y.reset(),p("close")};return(c,m)=>(i(),S(o(he),{open:c.open,"onUpdate:open":C},{default:s(()=>[a(o(be),{class:"sm:max-w-md"},{default:s(()=>[a(o(_e),null,{default:s(()=>[a(o(ve),{class:"flex items-center gap-2"},{default:s(()=>[a(o(q),{class:"w-5 h-5 text-amber-600"}),m[1]||(m[1]=d(" Company Required ",-1))]),_:1,__:[1]}),a(o(ke),null,{default:s(()=>[d(" To upgrade to a "+u(c.targetPlan)+" plan, you need to create a company. Please enter your company name below. ",1)]),_:1})]),_:1}),r("div",Se,[r("div",Fe,[a(o(we),{for:"company-name"},{default:s(()=>m[2]||(m[2]=[d("Company Name",-1)])),_:1,__:[2]}),a(o(xe),{id:"company-name",modelValue:o(y).company_name,"onUpdate:modelValue":m[0]||(m[0]=N=>o(y).company_name=N),placeholder:"Enter your company name",disabled:b.value,onKeydown:ue(k,["enter"])},null,8,["modelValue","disabled"]),o(y).errors.company_name?(i(),g("div",Pe,u(o(y).errors.company_name),1)):h("",!0)]),r("div",Re,[m[5]||(m[5]=r("p",{class:"text-sm text-blue-700 dark:text-blue-300"},[r("strong",null,"What happens next:")],-1)),r("ul",Ie,[m[3]||(m[3]=r("li",null,"We'll create your company profile",-1)),m[4]||(m[4]=r("li",null,"You'll be redirected to Stripe for payment",-1)),r("li",null,"Your account will be upgraded to "+u(c.targetPlan)+" plan",1)])])]),r("div",$e,[a(o(I),{variant:"outline",onClick:C,disabled:b.value,class:"flex-1"},{default:s(()=>m[6]||(m[6]=[d(" Cancel ",-1)])),_:1,__:[6]},8,["disabled"]),a(o(I),{onClick:k,disabled:!o(y).company_name.trim()||b.value,class:"flex-1"},{default:s(()=>[d(u(b.value?"Creating...":`Create Company & Upgrade to ${c.targetPlan}`),1)]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["open"]))}}),Me={class:"max-w-6xl mx-auto p-6"},Ae={key:0,class:"mb-6"},Le={class:"flex items-center gap-2 text-red-700 dark:text-red-300"},Ne={class:"text-sm font-medium"},Oe={class:"flex items-center justify-between"},Ue={class:"text-lg font-semibold"},Be={class:"text-gray-600 dark:text-gray-400"},je={key:0,class:"mt-2"},Ye={class:"text-sm text-gray-500"},Xe={class:"flex items-center gap-2"},qe={key:1,class:"mb-8"},Ve={class:"space-y-3"},Ke={key:0,class:"text-xs text-red-600"},Ge={key:1,class:"text-xs text-green-600"},We={class:"text-orange-700 dark:text-orange-300"},He={class:"font-medium"},Ze={class:"text-sm mt-2"},Je={key:0,class:"mt-4"},Te={class:"mb-8"},ze={key:0,class:"mb-6 flex justify-center"},Qe={class:"inline-flex rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-1"},et={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},tt={class:"text-3xl font-bold text-gray-900 dark:text-gray-100"},ot={class:"text-sm text-gray-500"},rt={key:0,class:"text-xs text-green-600 dark:text-green-400 mt-1"},at={class:"space-y-2 mb-6"},nt={key:1,class:"text-center"},Pt=z({__name:"Index",props:{user:{},company:{},plans:{},stripePublicKey:{}},setup(V){const f=V,L=de(),p=x(!1),y=x(!1),b=x(""),k=x(null),C=x(null),c=F(()=>f.company?.effective_subscription_type||f.company?.subscription_type||"FREE"),m=F(()=>f.company?.subscription_status==="active"),N=F(()=>!!f.company?.pending_change),w=x("month"),O=x(!1),U=x(""),H=F(()=>L.props.errors||{}),Q=F(()=>f.user&&f.user.company_id!==null&&f.user.company_id!==void 0),K=F(()=>{const t=c.value,e={...f.plans};return delete e.BUSINESS,t==="FREE"||delete e.FREE,e});console.log("=== SUBSCRIPTION PAGE LOADED ==="),console.log("Props:",f),console.log("Current plan computed:",c.value),console.log("Loading state:",p.value),console.log("Component initial setup complete"),console.log("Component fully loaded at:",new Date().toISOString());const $=t=>`£${(t/100).toFixed(0)}`,ee=t=>t===c.value?t==="MAXI"?"border-2 border-yellow-500 bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20":t==="MIDI"?"border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-2 border-gray-500 bg-gray-50 dark:bg-gray-900/20":"border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600",te=t=>{const e=c.value,l=f.plans[t],n={FREE:0,MIDI:1,MAXI:2,BUSINESS:3,LTD_SOLO:1.5,LTD_TEAM:2.5,LTD_AGENCY:3.5,LTD_BUSINESS:4.5},_=n[e]??0,E=n[t]??0;return E>_?`Upgrade to ${l.name}`:E<_?`Downgrade to ${l.name}`:`Switch to ${l.name}`},Z=t=>{console.log("=== BUTTON CLICKED ==="),console.log("Plan type:",t),console.log("Current time:",new Date().toISOString()),console.log("Loading state:",p.value),console.log("Current plan:",c.value),console.log("Function exists:",typeof G),console.log("About to call changePlan...");try{const n=f.plans[t]?.is_lifetime||!1?"month":w.value;G(t,n),console.log("changePlan called successfully")}catch(e){console.error("Error calling changePlan:",e)}},B=t=>{const e=f.plans[t];return e&&"price_yearly"in e?$(e.price_yearly):null},j=t=>f.plans[t]?.is_lifetime||!1,oe=()=>{!b.value.trim()||y.value||(y.value=!0,k.value=null,C.value=null,X.post("/ltd/redeem",{code:b.value.trim()},{onError:t=>{t.code?k.value=t.code:t.message?k.value=t.message:k.value="There was a problem redeeming your code. Please try again."},onSuccess:()=>{C.value="Your redemption code was applied successfully.",b.value=""},onFinish:()=>{y.value=!1}}))},G=async(t,e="month")=>{if(console.log("changePlan called with:",t,"interval:",e),console.log("loading.value:",p.value),console.log("currentPlan.value:",c.value),p.value||t===c.value){console.log("Exiting early - either loading or same plan");return}p.value=!0,console.log("Setting loading to true, using Inertia router approach..."),X.post("/subscription/change-plan",{plan:t,billing_interval:e},{onBefore:()=>(console.log("Inertia request starting..."),!0),onSuccess:l=>{console.log("Inertia request successful:",l),console.log("Full page props:",JSON.stringify(l.props,null,2)),console.log("All page props keys:",Object.keys(l.props)),console.log("Direct redirect_url check:",l.props.redirect_url),console.log("Has redirect_url prop:","redirect_url"in l.props);const n=l.props.flash;console.log("Flash data:",n),console.log("Flash type:",typeof n),console.log("Flash keys:",n?Object.keys(n):"no flash");let _=null;if(n?.redirect_url)_=n.redirect_url,console.log("Found redirect_url in flash.redirect_url");else if(l.props.redirect_url)_=l.props.redirect_url,console.log("Found redirect_url in page.props.redirect_url");else if(n&&typeof n=="object"){for(const[E,Y]of Object.entries(n))if(console.log(`Flash ${E}:`,Y),E==="redirect_url"||typeof Y=="string"&&Y.includes("checkout.stripe.com")){_=Y,console.log(`Found redirect URL in flash.${E}`);break}}_?(console.log("Redirecting to Stripe checkout:",_),window.location.href=_):(console.log("No redirect URL found, handling plan change"),(c.value==="MAXI"&&t==="MIDI"||c.value!=="FREE"&&t==="FREE")&&(console.log("Downgrade detected, emitting project reload event"),window.dispatchEvent(new CustomEvent("subscription-downgrade",{detail:{newPlan:t,oldPlan:c.value}}))),window.location.reload())},onError:l=>{if(console.error("Inertia request failed:",l),console.log("Error details:",JSON.stringify(l,null,2)),l.plan&&l.plan.includes("No company found")){console.log("No company found error detected, showing company creation modal"),U.value=t,O.value=!0;return}let n="An error occurred while changing your plan. Please try again.";l.plan?n=l.plan:l.message&&(n=l.message),alert(n)},onFinish:()=>{console.log("Setting loading to false"),p.value=!1}})},re=()=>{const t=document.querySelector('meta[name="csrf-token"]');return t?t.getAttribute("content"):""},ae=async()=>{console.log("=== TESTING CSRF ===");const t=re();console.log("CSRF Token:",t?"Found":"Missing");try{const e=await fetch("/subscription/test-csrf",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(console.log("CSRF Test Response:",e.status,e.statusText),e.ok){const l=await e.json();console.log("CSRF Test Success:",l)}else console.log("CSRF Test Failed:",e.status)}catch(e){console.error("CSRF Test Error:",e)}};ge(()=>{console.log("=== COMPONENT MOUNTED ==="),console.log("onMounted hook called at:",new Date().toISOString()),console.log("Final function check:",{handlePlanChange:typeof Z,changePlan:typeof G}),console.log("Running automatic CSRF test..."),ae()});const ne=async()=>{confirm("Are you sure you want to cancel your subscription? You'll keep your current plan benefits until the end of your billing period, then be downgraded to the FREE plan.")&&(p.value=!0,X.post("/subscription/cancel-subscription",{},{onSuccess:()=>{},onError:t=>{console.error("Error cancelling subscription:",t),alert("An error occurred while cancelling your subscription. Please try again.")},onFinish:()=>{p.value=!1}}))},se=()=>{O.value=!1,U.value=""},le=t=>{console.log("Company created successfully:",t),O.value=!1,U.value=""},ie=async()=>{confirm("Are you sure you want to reactivate your subscription? This will cancel the scheduled downgrade.")&&(p.value=!0,X.post("/subscription/reactivate",{},{onSuccess:()=>{},onError:t=>{console.error("Error reactivating subscription:",t),alert("An error occurred while reactivating your subscription. Please try again.")},onFinish:()=>{p.value=!1}}))};return(t,e)=>(i(),g(v,null,[a(o(me),{title:"Subscription Management"}),a(ye,null,{default:s(()=>[r("div",Me,[e[16]||(e[16]=r("div",{class:"mb-8"},[r("h1",{class:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2"}," Subscription Management "),r("p",{class:"text-gray-600 dark:text-gray-400"}," Manage your ZapTask subscription and billing settings ")],-1)),H.value.subscription?(i(),g("div",Ae,[a(o(P),{class:"border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20"},{default:s(()=>[a(o(R),{class:"p-4"},{default:s(()=>[r("div",Le,[a(o(q),{class:"w-5 h-5 flex-shrink-0"}),r("p",Ne,u(H.value.subscription),1)])]),_:1})]),_:1})])):h("",!0),a(o(P),{class:"mb-8"},{default:s(()=>[a(o(M),null,{default:s(()=>[a(o(A),{class:"flex items-center gap-2"},{default:s(()=>[a(o(Ce),{class:"w-5 h-5"}),e[3]||(e[3]=d(" Current Subscription ",-1))]),_:1,__:[3]})]),_:1}),a(o(R),null,{default:s(()=>[r("div",Oe,[r("div",null,[r("p",Ue,u(t.plans[c.value].name),1),r("p",Be,u(c.value==="FREE"?"Free forever":j(c.value)?`${$(t.plans[c.value].price)} one-time (lifetime access)`:`${$(t.plans[c.value].price)} per month`),1),t.company?.subscription_ends_at?(i(),g("div",je,[r("p",Ye,u(m.value?"Renews on":"Expires on")+": "+u(new Date(t.company.subscription_ends_at).toLocaleDateString()),1)])):h("",!0)]),r("div",Xe,[r("div",{class:D(["px-3 py-1 rounded-full text-sm font-medium",{"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300":m.value,"bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300":t.company?.subscription_status==="past_due","bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300":t.company?.subscription_status==="canceled","bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300":c.value==="FREE"}])},u(m.value?"Active":t.company?.subscription_status||"Free"),3)])])]),_:1})]),_:1}),Q.value?(i(),g("div",qe,[a(o(P),null,{default:s(()=>[a(o(M),null,{default:s(()=>[a(o(A),null,{default:s(()=>e[4]||(e[4]=[d("Redeem Lifetime Deal",-1)])),_:1,__:[4]}),a(o(W),null,{default:s(()=>e[5]||(e[5]=[d(" Got a redemption code? Enter it here to apply your lifetime ZapTask plan. ",-1)])),_:1,__:[5]})]),_:1}),a(o(R),null,{default:s(()=>[r("div",Ve,[e[6]||(e[6]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"}," Redemption Code ",-1)),pe(r("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>b.value=l),type:"text",placeholder:"Enter your lifetime deal redemption code",class:"block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700 dark:focus:border-blue-400 dark:focus:ring-blue-400"},null,512),[[fe,b.value]]),k.value?(i(),g("div",Ke,u(k.value),1)):h("",!0),C.value?(i(),g("div",Ge,u(C.value),1)):h("",!0),a(o(I),{class:"mt-2",disabled:y.value||!b.value.trim(),onClick:oe},{default:s(()=>[d(u(y.value?"Redeeming...":"Apply Redemption Code"),1)]),_:1},8,["disabled"])])]),_:1})]),_:1})])):h("",!0),N.value?(i(),S(o(P),{key:2,class:"mb-8 border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/20"},{default:s(()=>[a(o(M),null,{default:s(()=>[a(o(A),{class:"flex items-center gap-2 text-orange-700 dark:text-orange-300"},{default:s(()=>[a(o(q),{class:"w-5 h-5"}),e[7]||(e[7]=d(" Scheduled Plan Change ",-1))]),_:1,__:[7]})]),_:1}),a(o(R),null,{default:s(()=>[r("div",We,[r("p",He," Your plan will change from "+u(t.company?.pending_change?.current_plan)+" to "+u(t.company?.pending_change?.scheduled_plan)+" on "+u(t.company?.pending_change?.change_date?new Date(t.company.pending_change.change_date).toLocaleDateString():"your next billing date")+". ",1),r("p",Ze," You'll continue to have access to your current "+u(t.company?.pending_change?.current_plan)+" plan features until then. ",1),t.company?.pending_change?.scheduled_plan==="FREE"?(i(),g("div",Je,[a(o(I),{onClick:ie,disabled:p.value,variant:"outline",class:"bg-white text-orange-700 border-orange-300 hover:bg-orange-50 dark:bg-orange-900/50 dark:text-orange-300 dark:border-orange-600 dark:hover:bg-orange-800/50"},{default:s(()=>e[8]||(e[8]=[d(" Reactivate Subscription ",-1)])),_:1,__:[8]},8,["disabled"]),e[9]||(e[9]=r("p",{class:"text-xs mt-1"}," Cancel the scheduled downgrade and continue your subscription. ",-1))])):h("",!0)])]),_:1})]),_:1})):h("",!0),r("div",Te,[e[11]||(e[11]=r("h2",{class:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6"}," Available Plans ",-1)),K.value.MIDI||K.value.MAXI?(i(),g("div",ze,[r("div",Qe,[r("button",{onClick:e[1]||(e[1]=l=>w.value="month"),class:D(["px-4 py-2 rounded-md text-sm font-medium transition-colors",w.value==="month"?"bg-blue-600 text-white":"text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"])}," Monthly ",2),r("button",{onClick:e[2]||(e[2]=l=>w.value="year"),class:D(["px-4 py-2 rounded-md text-sm font-medium transition-colors",w.value==="year"?"bg-blue-600 text-white":"text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"])}," Yearly ",2)])])):h("",!0),r("div",et,[(i(!0),g(v,null,J(K.value,(l,n)=>(i(),S(o(P),{key:n,class:D(ee(n))},{default:s(()=>[a(o(M),{class:"text-center"},{default:s(()=>[a(o(A),{class:"flex items-center justify-center gap-2"},{default:s(()=>[n==="MAXI"?(i(),S(o(Ee),{key:0,class:"w-5 h-5 text-yellow-500"})):h("",!0),r("span",{class:D({"text-yellow-600 dark:text-yellow-400":n==="MAXI"})},u(l.name),3),n===c.value?(i(),S(o(T),{key:1,class:"w-5 h-5 text-green-500"})):h("",!0)]),_:2},1024),a(o(W),null,{default:s(()=>[r("div",tt,[n==="FREE"?(i(),g(v,{key:0},[d("Free")],64)):j(n)?(i(),g(v,{key:1},[d(u($(l.price)),1)],64)):w.value==="year"&&B(n)?(i(),g(v,{key:2},[d(u(B(n)),1)],64)):(i(),g(v,{key:3},[d(u($(l.price)),1)],64))]),r("div",ot,[n==="FREE"?(i(),g(v,{key:0},[d("Forever")],64)):j(n)?(i(),g(v,{key:1},[d("One-time payment")],64)):w.value==="year"?(i(),g(v,{key:2},[d("per year")],64)):(i(),g(v,{key:3},[d("per month")],64))]),!j(n)&&n!=="FREE"&&B(n)?(i(),g("div",rt,[w.value==="year"?(i(),g(v,{key:0},[d("Save £"+u((l.price*12-l.price_yearly)/100),1)],64)):(i(),g(v,{key:1},[d("or "+u(B(n))+"/year (save £"+u((l.price*12-l.price_yearly)/100)+")",1)],64))])):h("",!0)]),_:2},1024)]),_:2},1024),a(o(R),null,{default:s(()=>[r("ul",at,[(i(!0),g(v,null,J(l.features,_=>(i(),g("li",{key:_,class:"flex items-start gap-2 text-sm"},[a(o(T),{class:"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"}),r("span",null,u(_),1)]))),128))]),n!==c.value?(i(),S(o(I),{key:0,onClick:_=>Z(n),disabled:p.value,variant:n==="MIDI"||n==="MAXI"||n?.startsWith("LTD_")?"default":"outline",class:"w-full"},{default:s(()=>[d(u(te(n)),1)]),_:2},1032,["onClick","disabled","variant"])):(i(),g("div",nt,e[10]||(e[10]=[r("span",{class:"text-sm text-gray-500"},"Current Plan",-1)])))]),_:2},1024)]),_:2},1032,["class"]))),128))])]),c.value!=="FREE"&&t.company?.stripe_subscription_id&&(!N.value||t.company?.pending_change?.scheduled_plan!=="FREE")?(i(),S(o(P),{key:3,class:"border-red-200 dark:border-red-800"},{default:s(()=>[a(o(M),null,{default:s(()=>[a(o(A),{class:"flex items-center gap-2 text-red-600 dark:text-red-400"},{default:s(()=>[a(o(q),{class:"w-5 h-5"}),e[12]||(e[12]=d(" Danger Zone ",-1))]),_:1,__:[12]}),a(o(W),null,{default:s(()=>e[13]||(e[13]=[d(" Cancel your subscription. You'll keep your current plan benefits until the end of your billing period. ",-1)])),_:1,__:[13]})]),_:1}),a(o(R),null,{default:s(()=>[a(o(I),{onClick:ne,disabled:p.value,variant:"destructive"},{default:s(()=>e[14]||(e[14]=[d(" Cancel Subscription ",-1)])),_:1,__:[14]},8,["disabled"]),e[15]||(e[15]=r("p",{class:"text-xs text-gray-500 mt-2"}," Your subscription will remain active until the end of your current billing period. ",-1))]),_:1,__:[15]})]),_:1})):h("",!0)]),a(De,{open:O.value,"target-plan":U.value,onClose:se,onSuccess:le},null,8,["open","target-plan"])]),_:1})],64))}});export{Pt as default};
