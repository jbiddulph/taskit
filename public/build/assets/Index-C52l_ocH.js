import{d as K,K as Z,r as $,p as x,o as u,q as a,f as s,A as t,b as n,g as f,t as d,a as y,e as k,i as Q,D as ee,c as C,l as te,J as oe,n as O,F as L,j as B,L as X}from"./app-BdTYQ4Vq.js";import{C as ne,c as se,b as ae}from"./AppLayout.vue_vue_type_script_setup_true_lang-mS8_6LHp.js";import{_ as M}from"./index-CICssmjL.js";import{_ as w,a as E,b as P,c as R,d as q}from"./CardTitle.vue_vue_type_script_setup_true_lang-DeMM9pDI.js";import{_ as le,a as re,b as ce,c as ie,d as de}from"./DialogTitle.vue_vue_type_script_setup_true_lang-DMdTZeih.js";import{_ as ue,a as ge}from"./Label.vue_vue_type_script_setup_true_lang-Bniu529s.js";import{C as I}from"./index-zGHuXejJ.js";import{C as V}from"./check-DOZkvbnT.js";import"./useForwardExpose-BiKXXIWi.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-C0MpdbLi.js";import"./index-CU7IZpZl.js";const pe={class:"space-y-4 py-4"},me={class:"space-y-2"},fe={key:0,class:"text-sm text-red-600"},_e={class:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3"},be={class:"text-sm text-blue-600 dark:text-blue-400 mt-1 list-disc list-inside"},ye={class:"flex items-center gap-2"},ve=K({__name:"CompanyCreationModal",props:{open:{type:Boolean},targetPlan:{}},emits:["close","success"],setup(D,{emit:_}){const F=D,g=_,l=Z({company_name:"",target_plan:F.targetPlan}),b=$(!1),S=()=>{l.company_name.trim()&&(b.value=!0,l.target_plan=F.targetPlan,l.post("/subscription/create-company-and-upgrade",{onSuccess:p=>{const i=p.props.flash;i?.redirect_url?window.location.href=i.redirect_url:(g("success",p.props.company),g("close"))},onError:p=>{console.error("Company creation failed:",p)},onFinish:()=>{b.value=!1}}))},v=()=>{l.reset(),g("close")};return(p,i)=>(u(),x(t(de),{open:p.open,"onUpdate:open":v},{default:a(()=>[s(t(le),{class:"sm:max-w-md"},{default:a(()=>[s(t(re),null,{default:a(()=>[s(t(ce),{class:"flex items-center gap-2"},{default:a(()=>[s(t(I),{class:"w-5 h-5 text-amber-600"}),i[1]||(i[1]=f(" Company Required ",-1))]),_:1,__:[1]}),s(t(ie),null,{default:a(()=>[f(" To upgrade to a "+d(p.targetPlan)+" plan, you need to create a company. Please enter your company name below. ",1)]),_:1})]),_:1}),n("div",pe,[n("div",me,[s(t(ue),{for:"company-name"},{default:a(()=>i[2]||(i[2]=[f("Company Name",-1)])),_:1,__:[2]}),s(t(ge),{id:"company-name",modelValue:t(l).company_name,"onUpdate:modelValue":i[0]||(i[0]=A=>t(l).company_name=A),placeholder:"Enter your company name",disabled:b.value,onKeydown:Q(S,["enter"])},null,8,["modelValue","disabled"]),t(l).errors.company_name?(u(),y("div",fe,d(t(l).errors.company_name),1)):k("",!0)]),n("div",_e,[i[5]||(i[5]=n("p",{class:"text-sm text-blue-700 dark:text-blue-300"},[n("strong",null,"What happens next:")],-1)),n("ul",be,[i[3]||(i[3]=n("li",null,"We'll create your company profile",-1)),i[4]||(i[4]=n("li",null,"You'll be redirected to Stripe for payment",-1)),n("li",null,"Your account will be upgraded to "+d(p.targetPlan)+" plan",1)])])]),n("div",ye,[s(t(M),{variant:"outline",onClick:v,disabled:b.value,class:"flex-1"},{default:a(()=>i[6]||(i[6]=[f(" Cancel ",-1)])),_:1,__:[6]},8,["disabled"]),s(t(M),{onClick:S,disabled:!t(l).company_name.trim()||b.value,class:"flex-1"},{default:a(()=>[f(d(b.value?"Creating...":`Create Company & Upgrade to ${p.targetPlan}`),1)]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["open"]))}}),he={class:"max-w-6xl mx-auto p-6"},xe={key:0,class:"mb-6"},ke={class:"flex items-center gap-2 text-red-700 dark:text-red-300"},Ce={class:"text-sm font-medium"},we={class:"flex items-center justify-between"},Ee={class:"text-lg font-semibold"},Fe={class:"text-gray-600 dark:text-gray-400"},Se={key:0,class:"mt-2"},Pe={class:"text-sm text-gray-500"},Re={class:"flex items-center gap-2"},$e={class:"text-orange-700 dark:text-orange-300"},Ie={class:"font-medium"},Me={class:"text-sm mt-2"},De={class:"mb-8"},Ae={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},Ne={class:"text-3xl font-bold text-gray-900 dark:text-gray-100"},Oe={class:"text-sm text-gray-500"},Le={class:"space-y-2 mb-6"},je={key:1,class:"text-center"},Ge=K({__name:"Index",props:{user:{},company:{},plans:{},stripePublicKey:{}},setup(D){const _=D,F=ee(),g=$(!1),l=C(()=>_.company?.effective_subscription_type||_.company?.subscription_type||"FREE"),b=C(()=>_.company?.subscription_status==="active"),S=C(()=>!!_.company?.pending_change),v=$(!1),p=$(""),i=C(()=>F.props.errors||{}),A=C(()=>{if(l.value==="FREE")return _.plans;const e={..._.plans};return delete e.FREE,e});console.log("=== SUBSCRIPTION PAGE LOADED ==="),console.log("Props:",_),console.log("Current plan computed:",l.value),console.log("Loading state:",g.value),console.log("Component initial setup complete"),console.log("Component fully loaded at:",new Date().toISOString());const j=o=>`Â£${(o/100).toFixed(0)}`,Y=o=>o===l.value?o==="MAXI"?"border-2 border-yellow-500 bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20":o==="MIDI"?"border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-2 border-gray-500 bg-gray-50 dark:bg-gray-900/20":"border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600",H=o=>{const e=l.value,r=_.plans[o],c={FREE:0,MIDI:1,MAXI:2},m=c[e]||0,h=c[o]||0;return h>m?`Upgrade to ${r.name}`:h<m?`Downgrade to ${r.name}`:`Switch to ${r.name}`},U=o=>{console.log("=== BUTTON CLICKED ==="),console.log("Plan type:",o),console.log("Current time:",new Date().toISOString()),console.log("Loading state:",g.value),console.log("Current plan:",l.value),console.log("Function exists:",typeof N),console.log("About to call changePlan...");try{N(o),console.log("changePlan called successfully")}catch(e){console.error("Error calling changePlan:",e)}},N=async o=>{if(console.log("changePlan called with:",o),console.log("loading.value:",g.value),console.log("currentPlan.value:",l.value),g.value||o===l.value){console.log("Exiting early - either loading or same plan");return}g.value=!0,console.log("Setting loading to true, using Inertia router approach..."),X.post("/subscription/change-plan",{plan:o},{onBefore:()=>(console.log("Inertia request starting..."),!0),onSuccess:e=>{console.log("Inertia request successful:",e),console.log("Full page props:",JSON.stringify(e.props,null,2)),console.log("All page props keys:",Object.keys(e.props)),console.log("Direct redirect_url check:",e.props.redirect_url),console.log("Has redirect_url prop:","redirect_url"in e.props);const r=e.props.flash;console.log("Flash data:",r),console.log("Flash type:",typeof r),console.log("Flash keys:",r?Object.keys(r):"no flash");let c=null;if(r?.redirect_url)c=r.redirect_url,console.log("Found redirect_url in flash.redirect_url");else if(e.props.redirect_url)c=e.props.redirect_url,console.log("Found redirect_url in page.props.redirect_url");else if(r&&typeof r=="object"){for(const[m,h]of Object.entries(r))if(console.log(`Flash ${m}:`,h),m==="redirect_url"||typeof h=="string"&&h.includes("checkout.stripe.com")){c=h,console.log(`Found redirect URL in flash.${m}`);break}}c?(console.log("Redirecting to Stripe checkout:",c),window.location.href=c):(console.log("No redirect URL found, handling plan change"),(l.value==="MAXI"&&o==="MIDI"||l.value!=="FREE"&&o==="FREE")&&(console.log("Downgrade detected, emitting project reload event"),window.dispatchEvent(new CustomEvent("subscription-downgrade",{detail:{newPlan:o,oldPlan:l.value}}))),window.location.reload())},onError:e=>{if(console.error("Inertia request failed:",e),console.log("Error details:",JSON.stringify(e,null,2)),e.plan&&e.plan.includes("No company found")){console.log("No company found error detected, showing company creation modal"),p.value=o,v.value=!0;return}let r="An error occurred while changing your plan. Please try again.";e.plan?r=e.plan:e.message&&(r=e.message),alert(r)},onFinish:()=>{console.log("Setting loading to false"),g.value=!1}})},J=()=>{const o=document.querySelector('meta[name="csrf-token"]');return o?o.getAttribute("content"):""},T=async()=>{console.log("=== TESTING CSRF ===");const o=J();console.log("CSRF Token:",o?"Found":"Missing");try{const e=await fetch("/subscription/test-csrf",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(console.log("CSRF Test Response:",e.status,e.statusText),e.ok){const r=await e.json();console.log("CSRF Test Success:",r)}else console.log("CSRF Test Failed:",e.status)}catch(e){console.error("CSRF Test Error:",e)}};te(()=>{console.log("=== COMPONENT MOUNTED ==="),console.log("onMounted hook called at:",new Date().toISOString()),console.log("Final function check:",{handlePlanChange:typeof U,changePlan:typeof N}),console.log("Running automatic CSRF test..."),T()});const W=async()=>{confirm("Are you sure you want to cancel your subscription? Your account will be downgraded to the FREE plan.")&&(g.value=!0,X.post("/subscription/cancel-subscription",{},{onSuccess:()=>{},onError:o=>{console.error("Error cancelling subscription:",o),alert("An error occurred while cancelling your subscription. Please try again.")},onFinish:()=>{g.value=!1}}))},G=()=>{v.value=!1,p.value=""},z=o=>{console.log("Company created successfully:",o),v.value=!1,p.value=""};return(o,e)=>(u(),y(L,null,[s(t(oe),{title:"Subscription Management"}),s(ae,null,{default:a(()=>[n("div",he,[e[8]||(e[8]=n("div",{class:"mb-8"},[n("h1",{class:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2"}," Subscription Management "),n("p",{class:"text-gray-600 dark:text-gray-400"}," Manage your TaskIT subscription and billing settings ")],-1)),i.value.subscription?(u(),y("div",xe,[s(t(w),{class:"border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20"},{default:a(()=>[s(t(E),{class:"p-4"},{default:a(()=>[n("div",ke,[s(t(I),{class:"w-5 h-5 flex-shrink-0"}),n("p",Ce,d(i.value.subscription),1)])]),_:1})]),_:1})])):k("",!0),s(t(w),{class:"mb-8"},{default:a(()=>[s(t(P),null,{default:a(()=>[s(t(R),{class:"flex items-center gap-2"},{default:a(()=>[s(t(ne),{class:"w-5 h-5"}),e[0]||(e[0]=f(" Current Subscription ",-1))]),_:1,__:[0]})]),_:1}),s(t(E),null,{default:a(()=>[n("div",we,[n("div",null,[n("p",Ee,d(o.plans[l.value].name),1),n("p",Fe,d(l.value==="FREE"?"Free forever":`${j(o.plans[l.value].price)} per month`),1),o.company?.subscription_ends_at?(u(),y("div",Se,[n("p",Pe,d(b.value?"Renews on":"Expires on")+": "+d(new Date(o.company.subscription_ends_at).toLocaleDateString()),1)])):k("",!0)]),n("div",Re,[n("div",{class:O(["px-3 py-1 rounded-full text-sm font-medium",{"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300":b.value,"bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300":o.company?.subscription_status==="past_due","bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300":o.company?.subscription_status==="canceled","bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300":l.value==="FREE"}])},d(b.value?"Active":o.company?.subscription_status||"Free"),3)])])]),_:1})]),_:1}),S.value?(u(),x(t(w),{key:1,class:"mb-8 border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/20"},{default:a(()=>[s(t(P),null,{default:a(()=>[s(t(R),{class:"flex items-center gap-2 text-orange-700 dark:text-orange-300"},{default:a(()=>[s(t(I),{class:"w-5 h-5"}),e[1]||(e[1]=f(" Scheduled Plan Change ",-1))]),_:1,__:[1]})]),_:1}),s(t(E),null,{default:a(()=>[n("div",$e,[n("p",Ie," Your plan will change from "+d(o.company?.pending_change?.current_plan)+" to "+d(o.company?.pending_change?.scheduled_plan)+" on "+d(o.company?.pending_change?.change_date?new Date(o.company.pending_change.change_date).toLocaleDateString():"your next billing date")+". ",1),n("p",Me," You'll continue to have access to your current "+d(o.company?.pending_change?.current_plan)+" plan features until then. ",1)])]),_:1})]),_:1})):k("",!0),n("div",De,[e[3]||(e[3]=n("h2",{class:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6"}," Available Plans ",-1)),n("div",Ae,[(u(!0),y(L,null,B(A.value,(r,c)=>(u(),x(t(w),{key:c,class:O(Y(c))},{default:a(()=>[s(t(P),{class:"text-center"},{default:a(()=>[s(t(R),{class:"flex items-center justify-center gap-2"},{default:a(()=>[c==="MAXI"?(u(),x(t(se),{key:0,class:"w-5 h-5 text-yellow-500"})):k("",!0),n("span",{class:O({"text-yellow-600 dark:text-yellow-400":c==="MAXI"})},d(r.name),3),c===l.value?(u(),x(t(V),{key:1,class:"w-5 h-5 text-green-500"})):k("",!0)]),_:2},1024),s(t(q),null,{default:a(()=>[n("div",Ne,d(c==="FREE"?"Free":j(r.price)),1),n("div",Oe,d(c==="FREE"?"Forever":"per month"),1)]),_:2},1024)]),_:2},1024),s(t(E),null,{default:a(()=>[n("ul",Le,[(u(!0),y(L,null,B(r.features,m=>(u(),y("li",{key:m,class:"flex items-start gap-2 text-sm"},[s(t(V),{class:"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"}),n("span",null,d(m),1)]))),128))]),c!==l.value?(u(),x(t(M),{key:0,onClick:m=>U(c),disabled:g.value,variant:c==="MIDI"||c==="MAXI"?"default":"outline",class:"w-full"},{default:a(()=>[f(d(H(c)),1)]),_:2},1032,["onClick","disabled","variant"])):(u(),y("div",je,e[2]||(e[2]=[n("span",{class:"text-sm text-gray-500"},"Current Plan",-1)])))]),_:2},1024)]),_:2},1032,["class"]))),128))])]),l.value!=="FREE"&&o.company?.stripe_subscription_id?(u(),x(t(w),{key:2,class:"border-red-200 dark:border-red-800"},{default:a(()=>[s(t(P),null,{default:a(()=>[s(t(R),{class:"flex items-center gap-2 text-red-600 dark:text-red-400"},{default:a(()=>[s(t(I),{class:"w-5 h-5"}),e[4]||(e[4]=f(" Danger Zone ",-1))]),_:1,__:[4]}),s(t(q),null,{default:a(()=>e[5]||(e[5]=[f(" Cancel your subscription and downgrade to the FREE plan ",-1)])),_:1,__:[5]})]),_:1}),s(t(E),null,{default:a(()=>[s(t(M),{onClick:W,disabled:g.value,variant:"destructive"},{default:a(()=>e[6]||(e[6]=[f(" Cancel Subscription ",-1)])),_:1,__:[6]},8,["disabled"]),e[7]||(e[7]=n("p",{class:"text-xs text-gray-500 mt-2"}," Your subscription will remain active until the end of your current billing period. ",-1))]),_:1,__:[7]})]),_:1})):k("",!0)]),s(ve,{open:v.value,"target-plan":p.value,onClose:G,onSuccess:z},null,8,["open","target-plan"])]),_:1})],64))}});export{Ge as default};
