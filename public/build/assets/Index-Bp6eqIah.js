import{d as Y,u as Q,k as I,m as x,o as g,w as s,a,b as o,e as n,j as m,t as u,c as y,i as v,q as ee,N as te,A as C,D as oe,h as ne,s as O,F as L,r as X,p as j}from"./app-DFMbnPzo.js";import{_ as ae}from"./AppLayout.vue_vue_type_script_setup_true_lang-DGH7Euzw.js";import{_ as S}from"./AppLogoIcon.vue_vue_type_script_setup_true_lang-x7Larraa.js";import{_ as E,c as F,a as R,b as $}from"./CardTitle.vue_vue_type_script_setup_true_lang-CF9u6GxR.js";import{_ as q}from"./CardDescription.vue_vue_type_script_setup_true_lang-BGwUDVg9.js";import{_ as se,a as re,b as le,c as ie,d as ce}from"./DialogTitle.vue_vue_type_script_setup_true_lang-NfJ8xMgK.js";import{_ as ue}from"./Input.vue_vue_type_script_setup_true_lang-BPfYMuGT.js";import{_ as de}from"./Label.vue_vue_type_script_setup_true_lang-DWXALWjz.js";import{C as M,c as ge,e as pe}from"./AppSidebarLayout.vue_vue_type_script_setup_true_lang-zcEpI_AN.js";import{C as V}from"./check-Bsgl2JGu.js";import"./useForwardExpose-DnpiYPrb.js";import"./index-DKzRmfxm.js";const me={class:"space-y-4 py-4"},fe={class:"space-y-2"},_e={key:0,class:"text-sm text-red-600"},be={class:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3"},ye={class:"text-sm text-blue-600 dark:text-blue-400 mt-1 list-disc list-inside"},ve={class:"flex items-center gap-2"},he=Y({__name:"CompanyCreationModal",props:{open:{type:Boolean},targetPlan:{}},emits:["close","success"],setup(A,{emit:_}){const P=A,d=_,r=Q({company_name:"",target_plan:P.targetPlan}),b=I(!1),w=()=>{r.company_name.trim()&&(b.value=!0,r.target_plan=P.targetPlan,r.post("/subscription/create-company-and-upgrade",{onSuccess:p=>{const c=p.props.flash;c?.redirect_url?window.location.href=c.redirect_url:(d("success",p.props.company),d("close"))},onError:p=>{console.error("Company creation failed:",p)},onFinish:()=>{b.value=!1}}))},h=()=>{r.reset(),d("close")};return(p,c)=>(g(),x(o(ce),{open:p.open,"onUpdate:open":h},{default:s(()=>[a(o(se),{class:"sm:max-w-md"},{default:s(()=>[a(o(re),null,{default:s(()=>[a(o(le),{class:"flex items-center gap-2"},{default:s(()=>[a(o(M),{class:"w-5 h-5 text-amber-600"}),c[1]||(c[1]=m(" Company Required ",-1))]),_:1,__:[1]}),a(o(ie),null,{default:s(()=>[m(" To upgrade to a "+u(p.targetPlan)+" plan, you need to create a company. Please enter your company name below. ",1)]),_:1})]),_:1}),n("div",me,[n("div",fe,[a(o(de),{for:"company-name"},{default:s(()=>c[2]||(c[2]=[m("Company Name",-1)])),_:1,__:[2]}),a(o(ue),{id:"company-name",modelValue:o(r).company_name,"onUpdate:modelValue":c[0]||(c[0]=D=>o(r).company_name=D),placeholder:"Enter your company name",disabled:b.value,onKeydown:ee(w,["enter"])},null,8,["modelValue","disabled"]),o(r).errors.company_name?(g(),y("div",_e,u(o(r).errors.company_name),1)):v("",!0)]),n("div",be,[c[5]||(c[5]=n("p",{class:"text-sm text-blue-700 dark:text-blue-300"},[n("strong",null,"What happens next:")],-1)),n("ul",ye,[c[3]||(c[3]=n("li",null,"We'll create your company profile",-1)),c[4]||(c[4]=n("li",null,"You'll be redirected to Stripe for payment",-1)),n("li",null,"Your account will be upgraded to "+u(p.targetPlan)+" plan",1)])])]),n("div",ve,[a(o(S),{variant:"outline",onClick:h,disabled:b.value,class:"flex-1"},{default:s(()=>c[6]||(c[6]=[m(" Cancel ",-1)])),_:1,__:[6]},8,["disabled"]),a(o(S),{onClick:w,disabled:!o(r).company_name.trim()||b.value,class:"flex-1"},{default:s(()=>[m(u(b.value?"Creating...":`Create Company & Upgrade to ${p.targetPlan}`),1)]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["open"]))}}),ke={class:"max-w-6xl mx-auto p-6"},xe={key:0,class:"mb-6"},we={class:"flex items-center gap-2 text-red-700 dark:text-red-300"},Ce={class:"text-sm font-medium"},Ee={class:"flex items-center justify-between"},Fe={class:"text-lg font-semibold"},Se={class:"text-gray-600 dark:text-gray-400"},Pe={key:0,class:"mt-2"},Re={class:"text-sm text-gray-500"},$e={class:"flex items-center gap-2"},Ie={class:"text-orange-700 dark:text-orange-300"},Me={class:"font-medium"},Ae={class:"text-sm mt-2"},De={key:0,class:"mt-4"},Ne={class:"mb-8"},Oe={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},Le={class:"text-3xl font-bold text-gray-900 dark:text-gray-100"},je={class:"text-sm text-gray-500"},Ue={class:"space-y-2 mb-6"},Be={key:1,class:"text-center"},Qe=Y({__name:"Index",props:{user:{},company:{},plans:{},stripePublicKey:{}},setup(A){const _=A,P=te(),d=I(!1),r=C(()=>_.company?.effective_subscription_type||_.company?.subscription_type||"FREE"),b=C(()=>_.company?.subscription_status==="active"),w=C(()=>!!_.company?.pending_change),h=I(!1),p=I(""),c=C(()=>P.props.errors||{}),D=C(()=>{if(r.value==="FREE")return _.plans;const e={..._.plans};return delete e.FREE,e});console.log("=== SUBSCRIPTION PAGE LOADED ==="),console.log("Props:",_),console.log("Current plan computed:",r.value),console.log("Loading state:",d.value),console.log("Component initial setup complete"),console.log("Component fully loaded at:",new Date().toISOString());const U=t=>`Â£${(t/100).toFixed(0)}`,K=t=>t===r.value?t==="MAXI"?"border-2 border-yellow-500 bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20":t==="MIDI"?"border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-2 border-gray-500 bg-gray-50 dark:bg-gray-900/20":"border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600",H=t=>{const e=r.value,l=_.plans[t],i={FREE:0,MIDI:1,MAXI:2},f=i[e]||0,k=i[t]||0;return k>f?`Upgrade to ${l.name}`:k<f?`Downgrade to ${l.name}`:`Switch to ${l.name}`},B=t=>{console.log("=== BUTTON CLICKED ==="),console.log("Plan type:",t),console.log("Current time:",new Date().toISOString()),console.log("Loading state:",d.value),console.log("Current plan:",r.value),console.log("Function exists:",typeof N),console.log("About to call changePlan...");try{N(t),console.log("changePlan called successfully")}catch(e){console.error("Error calling changePlan:",e)}},N=async t=>{if(console.log("changePlan called with:",t),console.log("loading.value:",d.value),console.log("currentPlan.value:",r.value),d.value||t===r.value){console.log("Exiting early - either loading or same plan");return}d.value=!0,console.log("Setting loading to true, using Inertia router approach..."),j.post("/subscription/change-plan",{plan:t},{onBefore:()=>(console.log("Inertia request starting..."),!0),onSuccess:e=>{console.log("Inertia request successful:",e),console.log("Full page props:",JSON.stringify(e.props,null,2)),console.log("All page props keys:",Object.keys(e.props)),console.log("Direct redirect_url check:",e.props.redirect_url),console.log("Has redirect_url prop:","redirect_url"in e.props);const l=e.props.flash;console.log("Flash data:",l),console.log("Flash type:",typeof l),console.log("Flash keys:",l?Object.keys(l):"no flash");let i=null;if(l?.redirect_url)i=l.redirect_url,console.log("Found redirect_url in flash.redirect_url");else if(e.props.redirect_url)i=e.props.redirect_url,console.log("Found redirect_url in page.props.redirect_url");else if(l&&typeof l=="object"){for(const[f,k]of Object.entries(l))if(console.log(`Flash ${f}:`,k),f==="redirect_url"||typeof k=="string"&&k.includes("checkout.stripe.com")){i=k,console.log(`Found redirect URL in flash.${f}`);break}}i?(console.log("Redirecting to Stripe checkout:",i),window.location.href=i):(console.log("No redirect URL found, handling plan change"),(r.value==="MAXI"&&t==="MIDI"||r.value!=="FREE"&&t==="FREE")&&(console.log("Downgrade detected, emitting project reload event"),window.dispatchEvent(new CustomEvent("subscription-downgrade",{detail:{newPlan:t,oldPlan:r.value}}))),window.location.reload())},onError:e=>{if(console.error("Inertia request failed:",e),console.log("Error details:",JSON.stringify(e,null,2)),e.plan&&e.plan.includes("No company found")){console.log("No company found error detected, showing company creation modal"),p.value=t,h.value=!0;return}let l="An error occurred while changing your plan. Please try again.";e.plan?l=e.plan:e.message&&(l=e.message),alert(l)},onFinish:()=>{console.log("Setting loading to false"),d.value=!1}})},T=()=>{const t=document.querySelector('meta[name="csrf-token"]');return t?t.getAttribute("content"):""},W=async()=>{console.log("=== TESTING CSRF ===");const t=T();console.log("CSRF Token:",t?"Found":"Missing");try{const e=await fetch("/subscription/test-csrf",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(console.log("CSRF Test Response:",e.status,e.statusText),e.ok){const l=await e.json();console.log("CSRF Test Success:",l)}else console.log("CSRF Test Failed:",e.status)}catch(e){console.error("CSRF Test Error:",e)}};oe(()=>{console.log("=== COMPONENT MOUNTED ==="),console.log("onMounted hook called at:",new Date().toISOString()),console.log("Final function check:",{handlePlanChange:typeof B,changePlan:typeof N}),console.log("Running automatic CSRF test..."),W()});const G=async()=>{confirm("Are you sure you want to cancel your subscription? You'll keep your current plan benefits until the end of your billing period, then be downgraded to the FREE plan.")&&(d.value=!0,j.post("/subscription/cancel-subscription",{},{onSuccess:()=>{},onError:t=>{console.error("Error cancelling subscription:",t),alert("An error occurred while cancelling your subscription. Please try again.")},onFinish:()=>{d.value=!1}}))},J=()=>{h.value=!1,p.value=""},Z=t=>{console.log("Company created successfully:",t),h.value=!1,p.value=""},z=async()=>{confirm("Are you sure you want to reactivate your subscription? This will cancel the scheduled downgrade.")&&(d.value=!0,j.post("/subscription/reactivate",{},{onSuccess:()=>{},onError:t=>{console.error("Error reactivating subscription:",t),alert("An error occurred while reactivating your subscription. Please try again.")},onFinish:()=>{d.value=!1}}))};return(t,e)=>(g(),y(L,null,[a(o(ne),{title:"Subscription Management"}),a(ae,null,{default:s(()=>[n("div",ke,[e[10]||(e[10]=n("div",{class:"mb-8"},[n("h1",{class:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2"}," Subscription Management "),n("p",{class:"text-gray-600 dark:text-gray-400"}," Manage your ZapTask subscription and billing settings ")],-1)),c.value.subscription?(g(),y("div",xe,[a(o(E),{class:"border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20"},{default:s(()=>[a(o(F),{class:"p-4"},{default:s(()=>[n("div",we,[a(o(M),{class:"w-5 h-5 flex-shrink-0"}),n("p",Ce,u(c.value.subscription),1)])]),_:1})]),_:1})])):v("",!0),a(o(E),{class:"mb-8"},{default:s(()=>[a(o(R),null,{default:s(()=>[a(o($),{class:"flex items-center gap-2"},{default:s(()=>[a(o(ge),{class:"w-5 h-5"}),e[0]||(e[0]=m(" Current Subscription ",-1))]),_:1,__:[0]})]),_:1}),a(o(F),null,{default:s(()=>[n("div",Ee,[n("div",null,[n("p",Fe,u(t.plans[r.value].name),1),n("p",Se,u(r.value==="FREE"?"Free forever":`${U(t.plans[r.value].price)} per month`),1),t.company?.subscription_ends_at?(g(),y("div",Pe,[n("p",Re,u(b.value?"Renews on":"Expires on")+": "+u(new Date(t.company.subscription_ends_at).toLocaleDateString()),1)])):v("",!0)]),n("div",$e,[n("div",{class:O(["px-3 py-1 rounded-full text-sm font-medium",{"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300":b.value,"bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300":t.company?.subscription_status==="past_due","bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300":t.company?.subscription_status==="canceled","bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300":r.value==="FREE"}])},u(b.value?"Active":t.company?.subscription_status||"Free"),3)])])]),_:1})]),_:1}),w.value?(g(),x(o(E),{key:1,class:"mb-8 border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/20"},{default:s(()=>[a(o(R),null,{default:s(()=>[a(o($),{class:"flex items-center gap-2 text-orange-700 dark:text-orange-300"},{default:s(()=>[a(o(M),{class:"w-5 h-5"}),e[1]||(e[1]=m(" Scheduled Plan Change ",-1))]),_:1,__:[1]})]),_:1}),a(o(F),null,{default:s(()=>[n("div",Ie,[n("p",Me," Your plan will change from "+u(t.company?.pending_change?.current_plan)+" to "+u(t.company?.pending_change?.scheduled_plan)+" on "+u(t.company?.pending_change?.change_date?new Date(t.company.pending_change.change_date).toLocaleDateString():"your next billing date")+". ",1),n("p",Ae," You'll continue to have access to your current "+u(t.company?.pending_change?.current_plan)+" plan features until then. ",1),t.company?.pending_change?.scheduled_plan==="FREE"?(g(),y("div",De,[a(o(S),{onClick:z,disabled:d.value,variant:"outline",class:"bg-white text-orange-700 border-orange-300 hover:bg-orange-50 dark:bg-orange-900/50 dark:text-orange-300 dark:border-orange-600 dark:hover:bg-orange-800/50"},{default:s(()=>e[2]||(e[2]=[m(" Reactivate Subscription ",-1)])),_:1,__:[2]},8,["disabled"]),e[3]||(e[3]=n("p",{class:"text-xs mt-1"}," Cancel the scheduled downgrade and continue your subscription. ",-1))])):v("",!0)])]),_:1})]),_:1})):v("",!0),n("div",Ne,[e[5]||(e[5]=n("h2",{class:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6"}," Available Plans ",-1)),n("div",Oe,[(g(!0),y(L,null,X(D.value,(l,i)=>(g(),x(o(E),{key:i,class:O(K(i))},{default:s(()=>[a(o(R),{class:"text-center"},{default:s(()=>[a(o($),{class:"flex items-center justify-center gap-2"},{default:s(()=>[i==="MAXI"?(g(),x(o(pe),{key:0,class:"w-5 h-5 text-yellow-500"})):v("",!0),n("span",{class:O({"text-yellow-600 dark:text-yellow-400":i==="MAXI"})},u(l.name),3),i===r.value?(g(),x(o(V),{key:1,class:"w-5 h-5 text-green-500"})):v("",!0)]),_:2},1024),a(o(q),null,{default:s(()=>[n("div",Le,u(i==="FREE"?"Free":U(l.price)),1),n("div",je,u(i==="FREE"?"Forever":"per month"),1)]),_:2},1024)]),_:2},1024),a(o(F),null,{default:s(()=>[n("ul",Ue,[(g(!0),y(L,null,X(l.features,f=>(g(),y("li",{key:f,class:"flex items-start gap-2 text-sm"},[a(o(V),{class:"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"}),n("span",null,u(f),1)]))),128))]),i!==r.value?(g(),x(o(S),{key:0,onClick:f=>B(i),disabled:d.value,variant:i==="MIDI"||i==="MAXI"?"default":"outline",class:"w-full"},{default:s(()=>[m(u(H(i)),1)]),_:2},1032,["onClick","disabled","variant"])):(g(),y("div",Be,e[4]||(e[4]=[n("span",{class:"text-sm text-gray-500"},"Current Plan",-1)])))]),_:2},1024)]),_:2},1032,["class"]))),128))])]),r.value!=="FREE"&&t.company?.stripe_subscription_id&&(!w.value||t.company?.pending_change?.scheduled_plan!=="FREE")?(g(),x(o(E),{key:2,class:"border-red-200 dark:border-red-800"},{default:s(()=>[a(o(R),null,{default:s(()=>[a(o($),{class:"flex items-center gap-2 text-red-600 dark:text-red-400"},{default:s(()=>[a(o(M),{class:"w-5 h-5"}),e[6]||(e[6]=m(" Danger Zone ",-1))]),_:1,__:[6]}),a(o(q),null,{default:s(()=>e[7]||(e[7]=[m(" Cancel your subscription. You'll keep your current plan benefits until the end of your billing period. ",-1)])),_:1,__:[7]})]),_:1}),a(o(F),null,{default:s(()=>[a(o(S),{onClick:G,disabled:d.value,variant:"destructive"},{default:s(()=>e[8]||(e[8]=[m(" Cancel Subscription ",-1)])),_:1,__:[8]},8,["disabled"]),e[9]||(e[9]=n("p",{class:"text-xs text-gray-500 mt-2"}," Your subscription will remain active until the end of your current billing period. ",-1))]),_:1,__:[9]})]),_:1})):v("",!0)]),a(he,{open:h.value,"target-plan":p.value,onClose:J,onSuccess:Z},null,8,["open","target-plan"])]),_:1})],64))}});export{Qe as default};
