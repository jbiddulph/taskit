import{d as H,g as re,r as I,q as w,o as c,w as l,a,u as o,b as n,f as g,t as u,c as p,k,x as ne,E as ae,A as S,D as se,h as le,n as F,F as _,m as K,s as q}from"./app-CGUc2Pjb.js";import{_ as ie}from"./AppLayout.vue_vue_type_script_setup_true_lang-D135nrKj.js";import{_ as $}from"./index-ESApBQw3.js";import{_ as P,c as R,a as O,b as B}from"./CardTitle.vue_vue_type_script_setup_true_lang-DC1cVRZY.js";import{_ as W}from"./CardDescription.vue_vue_type_script_setup_true_lang-E2fmhoCf.js";import{a as ce,b as ue,c as de,_ as ge}from"./DialogTitle.vue_vue_type_script_setup_true_lang-7t9zUbjH.js";import{_ as pe}from"./DialogDescription.vue_vue_type_script_setup_true_lang-BmedBVU4.js";import{_ as me}from"./Input.vue_vue_type_script_setup_true_lang-C-dk7TdV.js";import{_ as fe}from"./Label.vue_vue_type_script_setup_true_lang-BnFp2r6k.js";import{C as U}from"./lock-CC5aCZVN.js";import{e as ye,f as _e}from"./useClientStore-DnD8Uq3S.js";import{C as G}from"./check-hUVrnT5Z.js";import"./AppSidebarLayout.vue_vue_type_script_setup_true_lang-C3hN0Dd5.js";import"./useForwardExpose-CHzENNLx.js";import"./Presence-CTHbQUeL.js";import"./x-CQNZfeQt.js";import"./createLucideIcon-CuAUzwjT.js";import"./VisuallyHidden-CgYLcHlX.js";import"./index-CMWG4mbA.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-Bhh2cEKh.js";import"./globe-Bz5RItfN.js";import"./loader-circle-C2iR2C_5.js";const be={class:"space-y-4 py-4"},ve={class:"space-y-2"},he={key:0,class:"text-sm text-red-600"},ke={class:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3"},xe={class:"text-sm text-blue-600 dark:text-blue-400 mt-1 list-disc list-inside"},we={class:"flex items-center gap-2"},Ce=H({__name:"CompanyCreationModal",props:{open:{type:Boolean},targetPlan:{}},emits:["close","success"],setup(j,{emit:b}){const D=j,m=b,i=re({company_name:"",target_plan:D.targetPlan}),h=I(!1),C=()=>{i.company_name.trim()&&(h.value=!0,i.target_plan=D.targetPlan,i.post("/subscription/create-company-and-upgrade",{onSuccess:f=>{const d=f.props.flash;d?.redirect_url?window.location.href=d.redirect_url:(m("success",f.props.company),m("close"))},onError:f=>{console.error("Company creation failed:",f)},onFinish:()=>{h.value=!1}}))},v=()=>{i.reset(),m("close")};return(f,d)=>(c(),w(o(ge),{open:f.open,"onUpdate:open":v},{default:l(()=>[a(o(ce),{class:"sm:max-w-md"},{default:l(()=>[a(o(ue),null,{default:l(()=>[a(o(de),{class:"flex items-center gap-2"},{default:l(()=>[a(o(U),{class:"w-5 h-5 text-amber-600"}),d[1]||(d[1]=g(" Company Required ",-1))]),_:1,__:[1]}),a(o(pe),null,{default:l(()=>[g(" To upgrade to a "+u(f.targetPlan)+" plan, you need to create a company. Please enter your company name below. ",1)]),_:1})]),_:1}),n("div",be,[n("div",ve,[a(o(fe),{for:"company-name"},{default:l(()=>d[2]||(d[2]=[g("Company Name",-1)])),_:1,__:[2]}),a(o(me),{id:"company-name",modelValue:o(i).company_name,"onUpdate:modelValue":d[0]||(d[0]=M=>o(i).company_name=M),placeholder:"Enter your company name",disabled:h.value,onKeydown:ne(C,["enter"])},null,8,["modelValue","disabled"]),o(i).errors.company_name?(c(),p("div",he,u(o(i).errors.company_name),1)):k("",!0)]),n("div",ke,[d[5]||(d[5]=n("p",{class:"text-sm text-blue-700 dark:text-blue-300"},[n("strong",null,"What happens next:")],-1)),n("ul",xe,[d[3]||(d[3]=n("li",null,"We'll create your company profile",-1)),d[4]||(d[4]=n("li",null,"You'll be redirected to Stripe for payment",-1)),n("li",null,"Your account will be upgraded to "+u(f.targetPlan)+" plan",1)])])]),n("div",we,[a(o($),{variant:"outline",onClick:v,disabled:h.value,class:"flex-1"},{default:l(()=>d[6]||(d[6]=[g(" Cancel ",-1)])),_:1,__:[6]},8,["disabled"]),a(o($),{onClick:C,disabled:!o(i).company_name.trim()||h.value,class:"flex-1"},{default:l(()=>[g(u(h.value?"Creating...":`Create Company & Upgrade to ${f.targetPlan}`),1)]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["open"]))}}),Ee={class:"max-w-6xl mx-auto p-6"},Se={key:0,class:"mb-6"},Fe={class:"flex items-center gap-2 text-red-700 dark:text-red-300"},Pe={class:"text-sm font-medium"},Re={class:"flex items-center justify-between"},Ie={class:"text-lg font-semibold"},$e={class:"text-gray-600 dark:text-gray-400"},De={key:0,class:"mt-2"},Me={class:"text-sm text-gray-500"},Ae={class:"flex items-center gap-2"},Le={class:"text-orange-700 dark:text-orange-300"},Ne={class:"font-medium"},Oe={class:"text-sm mt-2"},Be={key:0,class:"mt-4"},Ue={class:"mb-8"},je={key:0,class:"mb-6 flex justify-center"},Xe={class:"inline-flex rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-1"},Ye={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},qe={class:"text-3xl font-bold text-gray-900 dark:text-gray-100"},Ve={class:"text-sm text-gray-500"},Ke={key:0,class:"text-xs text-green-600 dark:text-green-400 mt-1"},We={class:"space-y-2 mb-6"},Ge={key:1,class:"text-center"},yt=H({__name:"Index",props:{user:{},company:{},plans:{},stripePublicKey:{}},setup(j){const b=j,D=ae(),m=I(!1),i=S(()=>b.company?.effective_subscription_type||b.company?.subscription_type||"FREE"),h=S(()=>b.company?.subscription_status==="active"),C=S(()=>!!b.company?.pending_change),v=I("month"),f=I(!1),d=I(""),M=S(()=>D.props.errors||{}),X=S(()=>{const e=i.value,t={...b.plans};return delete t.BUSINESS,e==="FREE"||delete t.FREE,t});console.log("=== SUBSCRIPTION PAGE LOADED ==="),console.log("Props:",b),console.log("Current plan computed:",i.value),console.log("Loading state:",m.value),console.log("Component initial setup complete"),console.log("Component fully loaded at:",new Date().toISOString());const E=e=>`£${(e/100).toFixed(0)}`,J=e=>e===i.value?e==="MAXI"?"border-2 border-yellow-500 bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20":e==="MIDI"?"border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-2 border-gray-500 bg-gray-50 dark:bg-gray-900/20":"border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600",Z=e=>{const t=i.value,s=b.plans[e],r={FREE:0,MIDI:1,MAXI:2,BUSINESS:3,LTD_SOLO:1.5,LTD_JB:1.5,LTD_TEAM:2.5,LTD_AGENCY:3.5,LTD_BUSINESS:4.5},y=r[t]??0,x=r[e]??0;return x>y?`Upgrade to ${s.name}`:x<y?`Downgrade to ${s.name}`:`Switch to ${s.name}`},V=e=>{console.log("=== BUTTON CLICKED ==="),console.log("Plan type:",e),console.log("Current time:",new Date().toISOString()),console.log("Loading state:",m.value),console.log("Current plan:",i.value),console.log("Function exists:",typeof Y),console.log("About to call changePlan...");try{const r=b.plans[e]?.is_lifetime||!1?"month":v.value;Y(e,r),console.log("changePlan called successfully")}catch(t){console.error("Error calling changePlan:",t)}},A=e=>{const t=b.plans[e];return t&&"price_yearly"in t?E(t.price_yearly):null},L=e=>b.plans[e]?.is_lifetime||!1,Y=async(e,t="month")=>{if(console.log("changePlan called with:",e,"interval:",t),console.log("loading.value:",m.value),console.log("currentPlan.value:",i.value),m.value||e===i.value){console.log("Exiting early - either loading or same plan");return}m.value=!0,console.log("Setting loading to true, using Inertia router approach..."),q.post("/subscription/change-plan",{plan:e,billing_interval:t},{onBefore:()=>(console.log("Inertia request starting..."),!0),onSuccess:s=>{console.log("Inertia request successful:",s),console.log("Full page props:",JSON.stringify(s.props,null,2)),console.log("All page props keys:",Object.keys(s.props)),console.log("Direct redirect_url check:",s.props.redirect_url),console.log("Has redirect_url prop:","redirect_url"in s.props);const r=s.props.flash;console.log("Flash data:",r),console.log("Flash type:",typeof r),console.log("Flash keys:",r?Object.keys(r):"no flash");let y=null;if(r?.redirect_url)y=r.redirect_url,console.log("Found redirect_url in flash.redirect_url");else if(s.props.redirect_url)y=s.props.redirect_url,console.log("Found redirect_url in page.props.redirect_url");else if(r&&typeof r=="object"){for(const[x,N]of Object.entries(r))if(console.log(`Flash ${x}:`,N),x==="redirect_url"||typeof N=="string"&&N.includes("checkout.stripe.com")){y=N,console.log(`Found redirect URL in flash.${x}`);break}}y?(console.log("Redirecting to Stripe checkout:",y),window.location.href=y):(console.log("No redirect URL found, handling plan change"),(i.value==="MAXI"&&e==="MIDI"||i.value!=="FREE"&&e==="FREE")&&(console.log("Downgrade detected, emitting project reload event"),window.dispatchEvent(new CustomEvent("subscription-downgrade",{detail:{newPlan:e,oldPlan:i.value}}))),window.location.reload())},onError:s=>{if(console.error("Inertia request failed:",s),console.log("Error details:",JSON.stringify(s,null,2)),s.plan&&s.plan.includes("No company found")){console.log("No company found error detected, showing company creation modal"),d.value=e,f.value=!0;return}let r="An error occurred while changing your plan. Please try again.";s.plan?r=s.plan:s.message&&(r=s.message),alert(r)},onFinish:()=>{console.log("Setting loading to false"),m.value=!1}})},z=()=>{const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""},Q=async()=>{console.log("=== TESTING CSRF ===");const e=z();console.log("CSRF Token:",e?"Found":"Missing");try{const t=await fetch("/subscription/test-csrf",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":e,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(console.log("CSRF Test Response:",t.status,t.statusText),t.ok){const s=await t.json();console.log("CSRF Test Success:",s)}else console.log("CSRF Test Failed:",t.status)}catch(t){console.error("CSRF Test Error:",t)}};se(()=>{console.log("=== COMPONENT MOUNTED ==="),console.log("onMounted hook called at:",new Date().toISOString()),console.log("Final function check:",{handlePlanChange:typeof V,changePlan:typeof Y}),console.log("Running automatic CSRF test..."),Q()});const T=async()=>{confirm("Are you sure you want to cancel your subscription? You'll keep your current plan benefits until the end of your billing period, then be downgraded to the FREE plan.")&&(m.value=!0,q.post("/subscription/cancel-subscription",{},{onSuccess:()=>{},onError:e=>{console.error("Error cancelling subscription:",e),alert("An error occurred while cancelling your subscription. Please try again.")},onFinish:()=>{m.value=!1}}))},ee=()=>{f.value=!1,d.value=""},te=e=>{console.log("Company created successfully:",e),f.value=!1,d.value=""},oe=async()=>{confirm("Are you sure you want to reactivate your subscription? This will cancel the scheduled downgrade.")&&(m.value=!0,q.post("/subscription/reactivate",{},{onSuccess:()=>{},onError:e=>{console.error("Error reactivating subscription:",e),alert("An error occurred while reactivating your subscription. Please try again.")},onFinish:()=>{m.value=!1}}))};return(e,t)=>(c(),p(_,null,[a(o(le),{title:"Subscription Management"}),a(ie,null,{default:l(()=>[n("div",Ee,[t[12]||(t[12]=n("div",{class:"mb-8"},[n("h1",{class:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2"}," Subscription Management "),n("p",{class:"text-gray-600 dark:text-gray-400"}," Manage your ZapTask subscription and billing settings ")],-1)),M.value.subscription?(c(),p("div",Se,[a(o(P),{class:"border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20"},{default:l(()=>[a(o(R),{class:"p-4"},{default:l(()=>[n("div",Fe,[a(o(U),{class:"w-5 h-5 flex-shrink-0"}),n("p",Pe,u(M.value.subscription),1)])]),_:1})]),_:1})])):k("",!0),a(o(P),{class:"mb-8"},{default:l(()=>[a(o(O),null,{default:l(()=>[a(o(B),{class:"flex items-center gap-2"},{default:l(()=>[a(o(ye),{class:"w-5 h-5"}),t[2]||(t[2]=g(" Current Subscription ",-1))]),_:1,__:[2]})]),_:1}),a(o(R),null,{default:l(()=>[n("div",Re,[n("div",null,[n("p",Ie,u(e.plans[i.value].name),1),n("p",$e,u(i.value==="FREE"?"Free forever":L(i.value)?`${E(e.plans[i.value].price)} one-time (lifetime access)`:`${E(e.plans[i.value].price)} per month`),1),e.company?.subscription_ends_at?(c(),p("div",De,[n("p",Me,u(h.value?"Renews on":"Expires on")+": "+u(new Date(e.company.subscription_ends_at).toLocaleDateString()),1)])):k("",!0)]),n("div",Ae,[n("div",{class:F(["px-3 py-1 rounded-full text-sm font-medium",{"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300":h.value,"bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300":e.company?.subscription_status==="past_due","bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300":e.company?.subscription_status==="canceled","bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300":i.value==="FREE"}])},u(h.value?"Active":e.company?.subscription_status||"Free"),3)])])]),_:1})]),_:1}),C.value?(c(),w(o(P),{key:1,class:"mb-8 border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/20"},{default:l(()=>[a(o(O),null,{default:l(()=>[a(o(B),{class:"flex items-center gap-2 text-orange-700 dark:text-orange-300"},{default:l(()=>[a(o(U),{class:"w-5 h-5"}),t[3]||(t[3]=g(" Scheduled Plan Change ",-1))]),_:1,__:[3]})]),_:1}),a(o(R),null,{default:l(()=>[n("div",Le,[n("p",Ne," Your plan will change from "+u(e.company?.pending_change?.current_plan)+" to "+u(e.company?.pending_change?.scheduled_plan)+" on "+u(e.company?.pending_change?.change_date?new Date(e.company.pending_change.change_date).toLocaleDateString():"your next billing date")+". ",1),n("p",Oe," You'll continue to have access to your current "+u(e.company?.pending_change?.current_plan)+" plan features until then. ",1),e.company?.pending_change?.scheduled_plan==="FREE"?(c(),p("div",Be,[a(o($),{onClick:oe,disabled:m.value,variant:"outline",class:"bg-white text-orange-700 border-orange-300 hover:bg-orange-50 dark:bg-orange-900/50 dark:text-orange-300 dark:border-orange-600 dark:hover:bg-orange-800/50"},{default:l(()=>t[4]||(t[4]=[g(" Reactivate Subscription ",-1)])),_:1,__:[4]},8,["disabled"]),t[5]||(t[5]=n("p",{class:"text-xs mt-1"}," Cancel the scheduled downgrade and continue your subscription. ",-1))])):k("",!0)])]),_:1})]),_:1})):k("",!0),n("div",Ue,[t[7]||(t[7]=n("h2",{class:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6"}," Available Plans ",-1)),X.value.MIDI||X.value.MAXI?(c(),p("div",je,[n("div",Xe,[n("button",{onClick:t[0]||(t[0]=s=>v.value="month"),class:F(["px-4 py-2 rounded-md text-sm font-medium transition-colors",v.value==="month"?"bg-blue-600 text-white":"text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"])}," Monthly ",2),n("button",{onClick:t[1]||(t[1]=s=>v.value="year"),class:F(["px-4 py-2 rounded-md text-sm font-medium transition-colors",v.value==="year"?"bg-blue-600 text-white":"text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"])}," Yearly ",2)])])):k("",!0),n("div",Ye,[(c(!0),p(_,null,K(X.value,(s,r)=>(c(),w(o(P),{key:r,class:F(J(r))},{default:l(()=>[a(o(O),{class:"text-center"},{default:l(()=>[a(o(B),{class:"flex items-center justify-center gap-2"},{default:l(()=>[r==="MAXI"?(c(),w(o(_e),{key:0,class:"w-5 h-5 text-yellow-500"})):k("",!0),n("span",{class:F({"text-yellow-600 dark:text-yellow-400":r==="MAXI"})},u(s.name),3),r===i.value?(c(),w(o(G),{key:1,class:"w-5 h-5 text-green-500"})):k("",!0)]),_:2},1024),a(o(W),null,{default:l(()=>[n("div",qe,[r==="FREE"?(c(),p(_,{key:0},[g("Free")],64)):L(r)?(c(),p(_,{key:1},[g(u(E(s.price)),1)],64)):v.value==="year"&&A(r)?(c(),p(_,{key:2},[g(u(A(r)),1)],64)):(c(),p(_,{key:3},[g(u(E(s.price)),1)],64))]),n("div",Ve,[r==="FREE"?(c(),p(_,{key:0},[g("Forever")],64)):L(r)?(c(),p(_,{key:1},[g("One-time payment")],64)):v.value==="year"?(c(),p(_,{key:2},[g("per year")],64)):(c(),p(_,{key:3},[g("per month")],64))]),!L(r)&&r!=="FREE"&&A(r)?(c(),p("div",Ke,[v.value==="year"?(c(),p(_,{key:0},[g("Save £"+u((s.price*12-s.price_yearly)/100),1)],64)):(c(),p(_,{key:1},[g("or "+u(A(r))+"/year (save £"+u((s.price*12-s.price_yearly)/100)+")",1)],64))])):k("",!0)]),_:2},1024)]),_:2},1024),a(o(R),null,{default:l(()=>[n("ul",We,[(c(!0),p(_,null,K(s.features,y=>(c(),p("li",{key:y,class:"flex items-start gap-2 text-sm"},[a(o(G),{class:"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"}),n("span",null,u(y),1)]))),128))]),r!==i.value?(c(),w(o($),{key:0,onClick:y=>V(r),disabled:m.value,variant:r==="MIDI"||r==="MAXI"||r?.startsWith("LTD_")?"default":"outline",class:"w-full"},{default:l(()=>[g(u(Z(r)),1)]),_:2},1032,["onClick","disabled","variant"])):(c(),p("div",Ge,t[6]||(t[6]=[n("span",{class:"text-sm text-gray-500"},"Current Plan",-1)])))]),_:2},1024)]),_:2},1032,["class"]))),128))])]),i.value!=="FREE"&&e.company?.stripe_subscription_id&&(!C.value||e.company?.pending_change?.scheduled_plan!=="FREE")?(c(),w(o(P),{key:2,class:"border-red-200 dark:border-red-800"},{default:l(()=>[a(o(O),null,{default:l(()=>[a(o(B),{class:"flex items-center gap-2 text-red-600 dark:text-red-400"},{default:l(()=>[a(o(U),{class:"w-5 h-5"}),t[8]||(t[8]=g(" Danger Zone ",-1))]),_:1,__:[8]}),a(o(W),null,{default:l(()=>t[9]||(t[9]=[g(" Cancel your subscription. You'll keep your current plan benefits until the end of your billing period. ",-1)])),_:1,__:[9]})]),_:1}),a(o(R),null,{default:l(()=>[a(o($),{onClick:T,disabled:m.value,variant:"destructive"},{default:l(()=>t[10]||(t[10]=[g(" Cancel Subscription ",-1)])),_:1,__:[10]},8,["disabled"]),t[11]||(t[11]=n("p",{class:"text-xs text-gray-500 mt-2"}," Your subscription will remain active until the end of your current billing period. ",-1))]),_:1,__:[11]})]),_:1})):k("",!0)]),a(Ce,{open:f.value,"target-plan":d.value,onClose:ee,onSuccess:te},null,8,["open","target-plan"])]),_:1})],64))}});export{yt as default};
