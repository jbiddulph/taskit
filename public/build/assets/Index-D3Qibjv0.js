import{d as H,G as K,r as T,c as v,l as J,a as f,o as i,f as n,A as o,L as Y,q as a,b as r,e as b,p as _,t as d,g as y,n as C,F as E,j as M,M as A}from"./app-BveCX7x3.js";import{C as z,c as W,b as Z}from"./AppLayout.vue_vue_type_script_setup_true_lang-yyCsMRnB.js";import{_ as D}from"./index--_ApOnHu.js";import{_ as h,a as x,b as F,c as S,d as O}from"./CardTitle.vue_vue_type_script_setup_true_lang-C5vVLy8c.js";import{C as $}from"./index-B6G3DZh5.js";import{C as N}from"./check-0Y1f2JYY.js";import"./useForwardExpose-B3QKfeDP.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-CfL6UDhj.js";import"./index-CU7IZpZl.js";const Q={class:"max-w-6xl mx-auto p-6"},ee={key:0,class:"mb-6"},te={class:"flex items-center gap-2 text-red-700 dark:text-red-300"},oe={class:"text-sm font-medium"},se={class:"flex items-center justify-between"},re={class:"text-lg font-semibold"},le={class:"text-gray-600 dark:text-gray-400"},ne={key:0,class:"mt-2"},ae={class:"text-sm text-gray-500"},ce={class:"flex items-center gap-2"},ie={class:"mb-8"},ue={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},de={class:"text-3xl font-bold text-gray-900 dark:text-gray-100"},ge={class:"text-sm text-gray-500"},pe={class:"space-y-2 mb-6"},fe={key:1,class:"text-center"},Ce=H({__name:"Index",props:{user:{},company:{},plans:{},stripePublicKey:{}},setup(L){const m=L,j=K(),g=T(!1),c=v(()=>m.company?.subscription_type||"FREE"),k=v(()=>m.company?.subscription_status==="active"),R=v(()=>j.props.errors||{}),X=v(()=>{if(c.value==="FREE")return m.plans;const e={...m.plans};return delete e.FREE,e});console.log("=== SUBSCRIPTION PAGE LOADED ==="),console.log("Props:",m),console.log("Current plan computed:",c.value),console.log("Loading state:",g.value),console.log("Component initial setup complete"),console.log("Component fully loaded at:",new Date().toISOString());const P=t=>`Â£${(t/100).toFixed(0)}`,B=t=>t===c.value?t==="MAXI"?"border-2 border-yellow-500 bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20":t==="MIDI"?"border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-2 border-gray-500 bg-gray-50 dark:bg-gray-900/20":"border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600",q=t=>{const e=c.value,s=m.plans[t],l={FREE:0,MIDI:1,MAXI:2},u=l[e]||0,p=l[t]||0;return p>u?`Upgrade to ${s.name}`:p<u?`Downgrade to ${s.name}`:`Switch to ${s.name}`},I=t=>{console.log("=== BUTTON CLICKED ==="),console.log("Plan type:",t),console.log("Current time:",new Date().toISOString()),console.log("Loading state:",g.value),console.log("Current plan:",c.value),console.log("Function exists:",typeof w),console.log("About to call changePlan...");try{w(t),console.log("changePlan called successfully")}catch(e){console.error("Error calling changePlan:",e)}},w=async t=>{if(console.log("changePlan called with:",t),console.log("loading.value:",g.value),console.log("currentPlan.value:",c.value),g.value||t===c.value){console.log("Exiting early - either loading or same plan");return}g.value=!0,console.log("Setting loading to true, using Inertia router approach..."),A.post("/subscription/change-plan",{plan:t},{onBefore:()=>(console.log("Inertia request starting..."),!0),onSuccess:e=>{console.log("Inertia request successful:",e),console.log("Full page props:",JSON.stringify(e.props,null,2)),console.log("All page props keys:",Object.keys(e.props)),console.log("Direct redirect_url check:",e.props.redirect_url),console.log("Has redirect_url prop:","redirect_url"in e.props);const s=e.props.flash;console.log("Flash data:",s),console.log("Flash type:",typeof s),console.log("Flash keys:",s?Object.keys(s):"no flash");let l=null;if(s?.redirect_url)l=s.redirect_url,console.log("Found redirect_url in flash.redirect_url");else if(e.props.redirect_url)l=e.props.redirect_url,console.log("Found redirect_url in page.props.redirect_url");else if(s&&typeof s=="object"){for(const[u,p]of Object.entries(s))if(console.log(`Flash ${u}:`,p),u==="redirect_url"||typeof p=="string"&&p.includes("checkout.stripe.com")){l=p,console.log(`Found redirect URL in flash.${u}`);break}}l?(console.log("Redirecting to Stripe checkout:",l),window.location.href=l):(console.log("No redirect URL found, handling plan change"),(c.value==="MAXI"&&t==="MIDI"||c.value!=="FREE"&&t==="FREE")&&(console.log("Downgrade detected, emitting project reload event"),window.dispatchEvent(new CustomEvent("subscription-downgrade",{detail:{newPlan:t,oldPlan:c.value}}))),window.location.reload())},onError:e=>{console.error("Inertia request failed:",e),console.log("Error details:",JSON.stringify(e,null,2));let s="An error occurred while changing your plan. Please try again.";e.plan?s=e.plan:e.message&&(s=e.message),alert(s)},onFinish:()=>{console.log("Setting loading to false"),g.value=!1}})},U=()=>{const t=document.querySelector('meta[name="csrf-token"]');return t?t.getAttribute("content"):""},V=async()=>{console.log("=== TESTING CSRF ===");const t=U();console.log("CSRF Token:",t?"Found":"Missing");try{const e=await fetch("/subscription/test-csrf",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(console.log("CSRF Test Response:",e.status,e.statusText),e.ok){const s=await e.json();console.log("CSRF Test Success:",s)}else console.log("CSRF Test Failed:",e.status)}catch(e){console.error("CSRF Test Error:",e)}};J(()=>{console.log("=== COMPONENT MOUNTED ==="),console.log("onMounted hook called at:",new Date().toISOString()),console.log("Final function check:",{handlePlanChange:typeof I,changePlan:typeof w}),console.log("Running automatic CSRF test..."),V()});const G=async()=>{confirm("Are you sure you want to cancel your subscription? Your account will be downgraded to the FREE plan.")&&(g.value=!0,A.post("/subscription/cancel-subscription",{},{onSuccess:()=>{},onError:t=>{console.error("Error cancelling subscription:",t),alert("An error occurred while cancelling your subscription. Please try again.")},onFinish:()=>{g.value=!1}}))};return(t,e)=>(i(),f(E,null,[n(o(Y),{title:"Subscription Management"}),n(Z,null,{default:a(()=>[r("div",Q,[e[7]||(e[7]=r("div",{class:"mb-8"},[r("h1",{class:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2"}," Subscription Management "),r("p",{class:"text-gray-600 dark:text-gray-400"}," Manage your TaskIT subscription and billing settings ")],-1)),R.value.subscription?(i(),f("div",ee,[n(o(h),{class:"border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20"},{default:a(()=>[n(o(x),{class:"p-4"},{default:a(()=>[r("div",te,[n(o($),{class:"w-5 h-5 flex-shrink-0"}),r("p",oe,d(R.value.subscription),1)])]),_:1})]),_:1})])):b("",!0),n(o(h),{class:"mb-8"},{default:a(()=>[n(o(F),null,{default:a(()=>[n(o(S),{class:"flex items-center gap-2"},{default:a(()=>[n(o(z),{class:"w-5 h-5"}),e[0]||(e[0]=y(" Current Subscription ",-1))]),_:1,__:[0]})]),_:1}),n(o(x),null,{default:a(()=>[r("div",se,[r("div",null,[r("p",re,d(t.plans[c.value].name),1),r("p",le,d(c.value==="FREE"?"Free forever":`${P(t.plans[c.value].price)} per month`),1),t.company?.subscription_ends_at?(i(),f("div",ne,[r("p",ae,d(k.value?"Renews on":"Expires on")+": "+d(new Date(t.company.subscription_ends_at).toLocaleDateString()),1)])):b("",!0)]),r("div",ce,[r("div",{class:C(["px-3 py-1 rounded-full text-sm font-medium",{"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300":k.value,"bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300":t.company?.subscription_status==="past_due","bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300":t.company?.subscription_status==="canceled","bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300":c.value==="FREE"}])},d(k.value?"Active":t.company?.subscription_status||"Free"),3)])])]),_:1})]),_:1}),r("div",ie,[e[2]||(e[2]=r("h2",{class:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6"}," Available Plans ",-1)),r("div",ue,[(i(!0),f(E,null,M(X.value,(s,l)=>(i(),_(o(h),{key:l,class:C(B(l))},{default:a(()=>[n(o(F),{class:"text-center"},{default:a(()=>[n(o(S),{class:"flex items-center justify-center gap-2"},{default:a(()=>[l==="MAXI"?(i(),_(o(W),{key:0,class:"w-5 h-5 text-yellow-500"})):b("",!0),r("span",{class:C({"text-yellow-600 dark:text-yellow-400":l==="MAXI"})},d(s.name),3),l===c.value?(i(),_(o(N),{key:1,class:"w-5 h-5 text-green-500"})):b("",!0)]),_:2},1024),n(o(O),null,{default:a(()=>[r("div",de,d(l==="FREE"?"Free":P(s.price)),1),r("div",ge,d(l==="FREE"?"Forever":"per month"),1)]),_:2},1024)]),_:2},1024),n(o(x),null,{default:a(()=>[r("ul",pe,[(i(!0),f(E,null,M(s.features,u=>(i(),f("li",{key:u,class:"flex items-start gap-2 text-sm"},[n(o(N),{class:"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"}),r("span",null,d(u),1)]))),128))]),l!==c.value?(i(),_(o(D),{key:0,onClick:u=>I(l),disabled:g.value,variant:l==="MIDI"||l==="MAXI"?"default":"outline",class:"w-full"},{default:a(()=>[y(d(q(l)),1)]),_:2},1032,["onClick","disabled","variant"])):(i(),f("div",fe,e[1]||(e[1]=[r("span",{class:"text-sm text-gray-500"},"Current Plan",-1)])))]),_:2},1024)]),_:2},1032,["class"]))),128))])]),c.value!=="FREE"&&t.company?.stripe_subscription_id?(i(),_(o(h),{key:1,class:"border-red-200 dark:border-red-800"},{default:a(()=>[n(o(F),null,{default:a(()=>[n(o(S),{class:"flex items-center gap-2 text-red-600 dark:text-red-400"},{default:a(()=>[n(o($),{class:"w-5 h-5"}),e[3]||(e[3]=y(" Danger Zone ",-1))]),_:1,__:[3]}),n(o(O),null,{default:a(()=>e[4]||(e[4]=[y(" Cancel your subscription and downgrade to the FREE plan ",-1)])),_:1,__:[4]})]),_:1}),n(o(x),null,{default:a(()=>[n(o(D),{onClick:G,disabled:g.value,variant:"destructive"},{default:a(()=>e[5]||(e[5]=[y(" Cancel Subscription ",-1)])),_:1,__:[5]},8,["disabled"]),e[6]||(e[6]=r("p",{class:"text-xs text-gray-500 mt-2"}," Your subscription will remain active until the end of your current billing period. ",-1))]),_:1,__:[6]})]),_:1})):b("",!0)])]),_:1})],64))}});export{Ce as default};
