import{r as g,d as N,P as A,A as z,D as E,I as Q,c as h,o as f,g as P,i as U,v as R,e as m,n as F,m as W,F as T,k as j,x as B,t as b,E as Y,a as q,b as V,f as X}from"./app-0IjFAyfz.js";import{a as H,t as $}from"./realtimeService-D53dbflw.js";class O{users=g([]);currentMentions=g([]);getUsers(){return this.users.value}setUsers(o){this.users.value=o}searchUsers(o){if(!o)return this.users.value;const l=o.toLowerCase();return this.users.value.filter(r=>r.name.toLowerCase().includes(l)||r.email.toLowerCase().includes(l))}parseMentions(o){const l=[],r=/@(\w+)/g;let s;for(;(s=r.exec(o))!==null;){const d=s[1],n=this.users.value.find(t=>t.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());n&&l.push({id:`${n.id}-${s.index}`,userId:n.id,userName:n.name,position:s.index,length:s[0].length})}return l}getSuggestions(o,l){const s=o.substring(0,l).match(/@(\w*)$/);if(!s)return[];const d=s[1];return this.searchUsers(d)}isInMention(o,l){const r=o.substring(0,l);return/@\w*$/.test(r)}formatMentions(o){return o.replace(/@(\w+)/g,(l,r)=>{const s=this.users.value.find(d=>d.name.toLowerCase().replace(/\s+/g,"")===r.toLowerCase());return s?`<span class="mention" data-user-id="${s.id}">@${s.name}</span>`:l})}extractMentions(o){const l=[],r=/@(\w+)/g;let s;for(;(s=r.exec(o))!==null;){const d=s[1],n=this.users.value.find(t=>t.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());n&&l.push({userId:n.id,userName:n.name})}return l}}const I=new O,G={class:"relative"},J=["placeholder"],Z=["onClick"],ee={key:0,class:"w-6 h-6 rounded-full overflow-hidden"},te=["src","alt"],se={key:1,class:"w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center"},ae={class:"text-xs font-medium text-gray-600 dark:text-gray-300"},oe={class:"text-sm font-medium text-gray-900 dark:text-gray-100"},ne={class:"text-xs text-gray-500 dark:text-gray-400"},re=N({__name:"MentionInput",props:{modelValue:{},placeholder:{default:"Add a comment..."},textareaClass:{default:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"},users:{}},emits:["update:modelValue","mention"],setup(y,{emit:o}){const l=y,r=o,s=g(),d=g(l.modelValue),n=g(!1),t=g([]),i=g(0),p=g(0),x=g("");A(()=>l.users,u=>{I.setUsers(u)},{immediate:!0}),A(d,u=>{r("update:modelValue",u);const w=I.extractMentions(u);w.length>0&&r("mention",w)});const _=z(()=>s.value?{position:"absolute",top:`${s.value.getBoundingClientRect().height+4}px`,left:"0px",width:"100%",maxWidth:"350px"}:{}),L=()=>{const u=s.value?.selectionStart||0,e=d.value.substring(0,u).match(/@(\w*)$/);e?(p.value=u-e[0].length,x.value=e[1],t.value=I.searchUsers(x.value),n.value=t.value.length>0,i.value=0):n.value=!1},M=u=>{if(n.value)switch(u.key){case"ArrowDown":u.preventDefault(),i.value=Math.min(i.value+1,t.value.length-1);break;case"ArrowUp":u.preventDefault(),i.value=Math.max(i.value-1,0);break;case"Enter":u.preventDefault(),t.value[i.value]&&k(t.value[i.value]);break;case"Escape":n.value=!1;break}},S=()=>{},D=()=>{},k=u=>{if(!s.value)return;const w=s.value.selectionStart||0,e=d.value.substring(0,p.value),c=d.value.substring(w),a=`@${u.name}`;d.value=e+a+c;const v=e.length+a.length;B(()=>{s.value&&(s.value.setSelectionRange(v,v),s.value.focus())}),n.value=!1},C=u=>{s.value&&!s.value.contains(u.target)&&(n.value=!1)};return E(()=>{document.addEventListener("click",C)}),Q(()=>{document.removeEventListener("click",C)}),(u,w)=>(f(),h("div",G,[P(m("textarea",{ref_key:"textarea",ref:s,"onUpdate:modelValue":w[0]||(w[0]=e=>d.value=e),onInput:L,onKeydown:M,onKeyup:S,onClick:D,placeholder:u.placeholder,class:F(u.textareaClass),rows:"3"},null,42,J),[[R,d.value]]),n.value&&t.value.length>0?(f(),h("div",{key:0,class:"absolute z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto",style:W(_.value)},[(f(!0),h(T,null,j(t.value,(e,c)=>(f(),h("div",{key:e.id,onClick:a=>k(e),class:F(["px-3 py-2 cursor-pointer flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700",c===i.value?"bg-blue-50 dark:bg-blue-900/20":""])},[e.avatar?(f(),h("div",ee,[m("img",{src:e.avatar,alt:e.name,class:"w-full h-full object-cover"},null,8,te)])):(f(),h("div",se,[m("span",ae,b(e.name.charAt(0).toUpperCase()),1)])),m("div",null,[m("div",oe,b(e.name),1),m("div",ne,b(e.email),1)])],10,Z))),128))],4)):U("",!0)]))}}),le=H(re,[["__scopeId","data-v-faa7ac16"]]);function ie(){const y=g([]),o=g(!1),l=g(null),r=async()=>{try{o.value=!0,l.value=null;const t=await fetch("/api/users",{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(t.ok){const i=await t.json();y.value=i}else l.value="Failed to load company users"}catch(t){l.value="Failed to load company users",console.error("Failed to load company users:",t)}finally{o.value=!1}},s=t=>y.value.find(i=>i.id===t),d=t=>y.value.find(i=>i.name.toLowerCase().includes(t.toLowerCase())),n=t=>{if(!t)return y.value;const i=t.toLowerCase();return y.value.filter(p=>p.name.toLowerCase().includes(i)||p.email.toLowerCase().includes(i))};return E(()=>{r()}),{users:y,loading:o,error:l,loadUsers:r,getUserById:s,getUserByName:d,searchUsers:n}}const de={class:"mt-6"},ue={class:"flex justify-end"},ce=["disabled"],me={key:0,class:"text-sm text-gray-500"},ge={key:1},ve={key:0,class:"text-sm text-gray-500"},he={class:"space-y-3"},fe=["data-comment-id"],pe={class:"flex items-start justify-between gap-3"},ye={class:"flex-1"},we={class:"mb-1 text-xs text-gray-600 dark:text-gray-400"},be={class:"font-medium text-gray-800 dark:text-gray-200"},xe={key:0,class:"flex gap-2"},_e=["onClick"],ke={key:1,class:"text-sm text-gray-800 dark:text-gray-100 whitespace-pre-line"},Ce={class:"flex gap-2"},$e=["onClick"],Ue=["onClick"],Me=N({__name:"TodoComments",props:{todoId:{}},setup(y){const o=y,r=Y().props?.auth?.user||null,s=g(!1),d=g(!1),n=g(""),t=g([]),i=g(null),p=g(""),x=g(null),{users:_}=ie();A(_,e=>{e.length>0&&I.setUsers(e)},{immediate:!0});const L=e=>{console.log("Mentions detected:",e)},M=async()=>{try{s.value=!0;const e=await $.getComments(o.todoId);t.value=e.sort((v,K)=>new Date(K.created_at).getTime()-new Date(v.created_at).getTime());const a=new URLSearchParams(window.location.search).get("highlight");a&&(x.value=parseInt(a),await B(),setTimeout(()=>{const v=document.querySelector(`[data-comment-id="${a}"]`);v&&v.scrollIntoView({behavior:"smooth",block:"center"})},100),setTimeout(()=>{x.value=null;const v=new URL(window.location.href);v.searchParams.delete("highlight"),window.history.replaceState({},"",v.toString())},5e3))}catch(e){console.error("Failed to load comments",e)}finally{s.value=!1}},S=async()=>{if(n.value.trim())try{d.value=!0;const e=await $.addComment(o.todoId,n.value.trim());!e.user&&r&&(e.user={id:r.id,name:r.name,email:r.email}),t.value.unshift(e),n.value="",window.$notify?.({type:"success",title:"Comment Added",message:"Your comment was added."})}catch(e){console.error("Failed to add comment",e),window.$notify?.({type:"error",title:"Add Failed",message:"Could not add comment."})}finally{d.value=!1}},D=e=>{i.value=e.id,p.value=e.content},k=()=>{i.value=null,p.value=""},C=async e=>{if(p.value.trim())try{const c=await $.updateComment(o.todoId,e.id,p.value.trim()),a=t.value.findIndex(v=>String(v.id)===String(e.id));a!==-1&&(t.value[a]=c,t.value=[...t.value]),i.value=null,p.value="",window.$notify?.({type:"success",title:"Comment Updated",message:"Your comment was updated."})}catch(c){console.error("Failed to update comment",c),window.$notify?.({type:"error",title:"Update Failed",message:"Could not update comment."})}},u=async e=>{if(confirm("Delete this comment?"))try{await $.deleteComment(o.todoId,e.id),t.value=t.value.filter(c=>String(c.id)!==String(e.id)),window.$notify?.({type:"success",title:"Comment Deleted",message:"Your comment was deleted."})}catch(c){console.error("Failed to delete comment",c),window.$notify?.({type:"error",title:"Delete Failed",message:"Could not delete comment."})}},w=e=>{try{return new Date(e).toLocaleString()}catch{return e}};return E(M),(e,c)=>(f(),h("div",de,[c[3]||(c[3]=m("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3"},"Comments",-1)),m("form",{onSubmit:X(S,["prevent"]),class:"mb-4"},[q(le,{modelValue:n.value,"onUpdate:modelValue":c[0]||(c[0]=a=>n.value=a),users:V(_),placeholder:"Write a comment... @mention someone",onMention:L,class:"mb-2"},null,8,["modelValue","users"]),m("div",ue,[m("button",{type:"submit",disabled:d.value||!n.value.trim(),class:"px-4 py-2 bg-blue-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"},b(d.value?"Adding...":"Add Comment"),9,ce)])],32),s.value?(f(),h("div",me,"Loading comments...")):(f(),h("div",ge,[t.value.length===0?(f(),h("div",ve,"No comments yet.")):U("",!0),m("ul",he,[(f(!0),h(T,null,j(t.value,a=>(f(),h("li",{key:a.id,"data-comment-id":a.id,class:F(["p-3 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 transition-all duration-300",{"ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-600":x.value===a.id}])},[m("div",pe,[m("div",ye,[m("div",we,[m("span",be,b(a.user?.name||"User"),1),c[2]||(c[2]=m("span",{class:"mx-1"},"Â·",-1)),m("span",null,b(w(a.created_at)),1)]),i.value===a.id?(f(),h("div",xe,[P(m("input",{"onUpdate:modelValue":c[1]||(c[1]=v=>p.value=v),type:"text",class:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"},null,512),[[R,p.value]]),m("button",{onClick:v=>C(a),class:"px-3 py-2 bg-green-600 text-white rounded-md"},"Save",8,_e),m("button",{onClick:k,class:"px-3 py-2 bg-gray-300 text-gray-800 rounded-md"},"Cancel")])):(f(),h("div",ke,b(a.content),1))]),m("div",Ce,[i.value!==a.id&&a.user?.id===V(r)?.id?(f(),h("button",{key:0,onClick:v=>D(a),class:"text-gray-500 hover:text-blue-600 text-sm"},"Edit",8,$e)):U("",!0),a.user?.id===V(r)?.id?(f(),h("button",{key:1,onClick:v=>u(a),class:"text-gray-500 hover:text-red-600 text-sm"},"Delete",8,Ue)):U("",!0)])])],10,fe))),128))])]))]))}});export{Me as _};
