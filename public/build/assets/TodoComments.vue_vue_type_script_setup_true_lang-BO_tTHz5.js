import{r as g,d as N,P as A,A as Q,D as P,I as Y,c as h,o as p,g as R,i as L,v as T,e as u,n as E,m as q,F as B,k as j,x as K,t as w,B as W,E as X,b as y,a as H,f as O}from"./app-DnVdth5b.js";import{a as G,t as M}from"./realtimeService-ZseXJd-M.js";class J{users=g([]);currentMentions=g([]);getUsers(){return this.users.value}setUsers(t){this.users.value=t}searchUsers(t){if(!t)return this.users.value;const n=t.toLowerCase();return this.users.value.filter(v=>v.name.toLowerCase().includes(n)||v.email.toLowerCase().includes(n))}parseMentions(t){const n=[],v=/@(\w+)/g;let e;for(;(e=v.exec(t))!==null;){const d=e[1],l=this.users.value.find(a=>a.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());l&&n.push({id:`${l.id}-${e.index}`,userId:l.id,userName:l.name,position:e.index,length:e[0].length})}return n}getSuggestions(t,n){const e=t.substring(0,n).match(/@(\w*)$/);if(!e)return[];const d=e[1];return this.searchUsers(d)}isInMention(t,n){const v=t.substring(0,n);return/@\w*$/.test(v)}formatMentions(t){return t.replace(/@(\w+)/g,(n,v)=>{const e=this.users.value.find(d=>d.name.toLowerCase().replace(/\s+/g,"")===v.toLowerCase());return e?`<span class="mention" data-user-id="${e.id}">@${e.name}</span>`:n})}extractMentions(t){const n=[],v=/@(\w+)/g;let e;for(;(e=v.exec(t))!==null;){const d=e[1],l=this.users.value.find(a=>a.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());l&&n.push({userId:l.id,userName:l.name})}return n}}const S=new J,Z={class:"relative"},ee=["placeholder"],te=["onClick"],se={key:0,class:"w-6 h-6 rounded-full overflow-hidden"},ae=["src","alt"],oe={key:1,class:"w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center"},ne={class:"text-xs font-medium text-gray-600 dark:text-gray-300"},re={class:"text-sm font-medium text-gray-900 dark:text-gray-100"},le={class:"text-xs text-gray-500 dark:text-gray-400"},ie=N({__name:"MentionInput",props:{modelValue:{},placeholder:{default:"Add a comment..."},textareaClass:{default:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"},users:{}},emits:["update:modelValue","mention"],setup(b,{emit:t}){const n=b,v=t,e=g(),d=g(n.modelValue),l=g(!1),a=g([]),o=g(0),x=g(0),_=g("");A(()=>n.users,i=>{S.setUsers(i)},{immediate:!0}),A(d,i=>{v("update:modelValue",i);const k=S.extractMentions(i);k.length>0&&v("mention",k)});const C=Q(()=>e.value?{position:"absolute",top:`${e.value.getBoundingClientRect().height+4}px`,left:"0px",width:"100%",maxWidth:"350px"}:{}),$=()=>{const i=e.value?.selectionStart||0,c=d.value.substring(0,i).match(/@(\w*)$/);c?(x.value=i-c[0].length,_.value=c[1],a.value=S.searchUsers(_.value),l.value=a.value.length>0,o.value=0):l.value=!1},D=i=>{if(l.value)switch(i.key){case"ArrowDown":i.preventDefault(),o.value=Math.min(o.value+1,a.value.length-1);break;case"ArrowUp":i.preventDefault(),o.value=Math.max(o.value-1,0);break;case"Enter":i.preventDefault(),a.value[o.value]&&U(a.value[o.value]);break;case"Escape":l.value=!1;break}},V=()=>{},F=()=>{},U=i=>{if(!e.value)return;const k=e.value.selectionStart||0,c=d.value.substring(0,x.value),s=d.value.substring(k),m=`@${i.name}`;d.value=c+m+s;const r=c.length+m.length;K(()=>{e.value&&(e.value.setSelectionRange(r,r),e.value.focus())}),l.value=!1},I=i=>{e.value&&!e.value.contains(i.target)&&(l.value=!1)};return P(()=>{document.addEventListener("click",I)}),Y(()=>{document.removeEventListener("click",I)}),(i,k)=>(p(),h("div",Z,[R(u("textarea",{ref_key:"textarea",ref:e,"onUpdate:modelValue":k[0]||(k[0]=c=>d.value=c),onInput:$,onKeydown:D,onKeyup:V,onClick:F,placeholder:i.placeholder,class:E(i.textareaClass),rows:"3"},null,42,ee),[[T,d.value]]),l.value&&a.value.length>0?(p(),h("div",{key:0,class:"absolute z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto",style:q(C.value)},[(p(!0),h(B,null,j(a.value,(c,s)=>(p(),h("div",{key:c.id,onClick:m=>U(c),class:E(["px-3 py-2 cursor-pointer flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700",s===o.value?"bg-blue-50 dark:bg-blue-900/20":""])},[c.avatar?(p(),h("div",se,[u("img",{src:c.avatar,alt:c.name,class:"w-full h-full object-cover"},null,8,ae)])):(p(),h("div",oe,[u("span",ne,w(c.name.charAt(0).toUpperCase()),1)])),u("div",null,[u("div",re,w(c.name),1),u("div",le,w(c.email),1)])],10,te))),128))],4)):L("",!0)]))}}),de=G(ie,[["__scopeId","data-v-faa7ac16"]]);function ue(){const b=g([]),t=g(!1),n=g(null),v=async()=>{try{t.value=!0,n.value=null;const a=await fetch("/api/users",{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(a.ok){const o=await a.json();b.value=o}else n.value="Failed to load company users"}catch(a){n.value="Failed to load company users",console.error("Failed to load company users:",a)}finally{t.value=!1}},e=a=>b.value.find(o=>o.id===a),d=a=>b.value.find(o=>o.name.toLowerCase().includes(a.toLowerCase())),l=a=>{if(!a)return b.value;const o=a.toLowerCase();return b.value.filter(x=>x.name.toLowerCase().includes(o)||x.email.toLowerCase().includes(o))};return P(()=>{v()}),{users:b,loading:t,error:n,loadUsers:v,getUserById:e,getUserByName:d,searchUsers:l}}const ce={class:"mt-6"},me={class:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3"},ge={class:"flex justify-end"},ve=["disabled"],he={key:0,class:"text-sm text-gray-500"},pe={key:1},fe={key:0,class:"text-sm text-gray-500"},ye={class:"space-y-3"},we=["data-comment-id"],be={class:"flex items-start justify-between gap-3"},xe={class:"flex-1"},_e={class:"mb-1 text-xs text-gray-600 dark:text-gray-400"},ke={class:"font-medium text-gray-800 dark:text-gray-200"},Ce={key:0,class:"flex gap-2"},$e=["onClick"],Ue={key:1,class:"text-sm text-gray-800 dark:text-gray-100 whitespace-pre-line"},Ie={class:"flex gap-2"},Me=["onClick"],Le=["onClick"],Ve=N({__name:"TodoComments",props:{todoId:{}},setup(b){const{t}=W(),n=b,e=X().props?.auth?.user||null,d=g(!1),l=g(!1),a=g(""),o=g([]),x=g(null),_=g(""),C=g(null),{users:$}=ue();A($,s=>{s.length>0&&S.setUsers(s)},{immediate:!0});const D=s=>{console.log("Mentions detected:",s)},V=async()=>{try{d.value=!0;const s=await M.getComments(n.todoId);o.value=s.sort((f,z)=>new Date(z.created_at).getTime()-new Date(f.created_at).getTime());const r=new URLSearchParams(window.location.search).get("highlight");r&&(C.value=parseInt(r),await K(),setTimeout(()=>{const f=document.querySelector(`[data-comment-id="${r}"]`);f&&f.scrollIntoView({behavior:"smooth",block:"center"})},100),setTimeout(()=>{C.value=null;const f=new URL(window.location.href);f.searchParams.delete("highlight"),window.history.replaceState({},"",f.toString())},5e3))}catch(s){console.error("Failed to load comments",s)}finally{d.value=!1}},F=async()=>{if(a.value.trim())try{l.value=!0;const s=await M.addComment(n.todoId,a.value.trim());!s.user&&e&&(s.user={id:e.id,name:e.name,email:e.email}),o.value.unshift(s),a.value="",window.$notify?.({type:"success",title:"Comment Added",message:"Your comment was added."})}catch(s){console.error("Failed to add comment",s),window.$notify?.({type:"error",title:"Add Failed",message:"Could not add comment."})}finally{l.value=!1}},U=s=>{x.value=s.id,_.value=s.content},I=()=>{x.value=null,_.value=""},i=async s=>{if(_.value.trim())try{const m=await M.updateComment(n.todoId,s.id,_.value.trim()),r=o.value.findIndex(f=>String(f.id)===String(s.id));r!==-1&&(o.value[r]=m,o.value=[...o.value]),x.value=null,_.value="",window.$notify?.({type:"success",title:"Comment Updated",message:"Your comment was updated."})}catch(m){console.error("Failed to update comment",m),window.$notify?.({type:"error",title:"Update Failed",message:"Could not update comment."})}},k=async s=>{if(confirm("Delete this comment?"))try{await M.deleteComment(n.todoId,s.id),o.value=o.value.filter(m=>String(m.id)!==String(s.id)),window.$notify?.({type:"success",title:"Comment Deleted",message:"Your comment was deleted."})}catch(m){console.error("Failed to delete comment",m),window.$notify?.({type:"error",title:"Delete Failed",message:"Could not delete comment."})}},c=s=>{try{return new Date(s).toLocaleString()}catch{return s}};return P(V),(s,m)=>(p(),h("div",ce,[u("h3",me,w(y(t)("comments.title")),1),u("form",{onSubmit:O(F,["prevent"]),class:"mb-4"},[H(de,{modelValue:a.value,"onUpdate:modelValue":m[0]||(m[0]=r=>a.value=r),users:y($),placeholder:y(t)("comments.write_comment"),onMention:D,class:"mb-2"},null,8,["modelValue","users","placeholder"]),u("div",ge,[u("button",{type:"submit",disabled:l.value||!a.value.trim(),class:"px-4 py-2 bg-blue-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"},w(l.value?y(t)("comments.adding"):y(t)("comments.add_comment")),9,ve)])],32),d.value?(p(),h("div",he,w(y(t)("comments.loading")),1)):(p(),h("div",pe,[o.value.length===0?(p(),h("div",fe,w(y(t)("comments.no_comments")),1)):L("",!0),u("ul",ye,[(p(!0),h(B,null,j(o.value,r=>(p(),h("li",{key:r.id,"data-comment-id":r.id,class:E(["p-3 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 transition-all duration-300",{"ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-600":C.value===r.id}])},[u("div",be,[u("div",xe,[u("div",_e,[u("span",ke,w(r.user?.name||y(t)("comments.user")),1),m[2]||(m[2]=u("span",{class:"mx-1"},"Â·",-1)),u("span",null,w(c(r.created_at)),1)]),x.value===r.id?(p(),h("div",Ce,[R(u("input",{"onUpdate:modelValue":m[1]||(m[1]=f=>_.value=f),type:"text",class:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"},null,512),[[T,_.value]]),u("button",{onClick:f=>i(r),class:"px-3 py-2 bg-green-600 text-white rounded-md"},w(y(t)("common.save")),9,$e),u("button",{onClick:I,class:"px-3 py-2 bg-gray-300 text-gray-800 rounded-md"},w(y(t)("common.cancel")),1)])):(p(),h("div",Ue,w(r.content),1))]),u("div",Ie,[x.value!==r.id&&r.user?.id===y(e)?.id?(p(),h("button",{key:0,onClick:f=>U(r),class:"text-gray-500 hover:text-blue-600 text-sm"},w(y(t)("common.edit")),9,Me)):L("",!0),r.user?.id===y(e)?.id?(p(),h("button",{key:1,onClick:f=>k(r),class:"text-gray-500 hover:text-red-600 text-sm"},w(y(t)("common.delete")),9,Le)):L("",!0)])])],10,we))),128))])]))]))}});export{Ve as _};
