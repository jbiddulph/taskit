import{r as g,d as P,P as j,A as z,D as E,I as Q,c as h,o as f,j as N,k as M,v as R,b as c,n as A,p as Y,F as T,m as B,y as O,t as b,B as q,E as W,u as y,a as X,i as H}from"./app-BuS22ihf.js";import{a as G,t as U}from"./useClientStore-D_XRFZaQ.js";class J{users=g([]);currentMentions=g([]);getUsers(){return this.users.value}setUsers(s){this.users.value=s}searchUsers(s){if(!s)return this.users.value;const n=s.toLowerCase();return this.users.value.filter(v=>v.name.toLowerCase().includes(n)||v.email.toLowerCase().includes(n))}parseMentions(s){const n=[],v=/@([^\s@]+)/gu;let e;for(;(e=v.exec(s))!==null;){const d=e[1],i=this.users.value.find(o=>o.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());i&&n.push({id:`${i.id}-${e.index}`,userId:i.id,userName:i.name,position:e.index,length:e[0].length})}return n}getSuggestions(s,n){const e=s.substring(0,n).match(/@([^\s@]*)$/u);if(!e)return[];const d=e[1];return this.searchUsers(d)}isInMention(s,n){const v=s.substring(0,n);return/@[^\s@]*$/u.test(v)}formatMentions(s){return s.replace(/@([^\s@]+)/gu,(n,v)=>{const e=this.users.value.find(d=>d.name.toLowerCase().replace(/\s+/g,"")===v.toLowerCase());return e?`<span class="mention" data-user-id="${e.id}">@${e.name}</span>`:n})}extractMentions(s){const n=[],v=/@([^\s@]+)/gu;let e;for(;(e=v.exec(s))!==null;){const d=e[1],i=this.users.value.find(o=>o.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());i&&n.push({userId:i.id,userName:i.name})}return n}}const L=new J,Z={class:"relative"},ee=["placeholder"],te=["onClick"],ae={key:0,class:"w-6 h-6 rounded-full overflow-hidden"},se=["src","alt"],oe={key:1,class:"w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center"},ne={class:"text-xs font-medium text-gray-600 dark:text-gray-300"},re={class:"text-sm font-medium text-gray-900 dark:text-gray-100"},le={class:"text-xs text-gray-500 dark:text-gray-400"},ie=P({__name:"MentionInput",props:{modelValue:{},placeholder:{default:"Add a comment..."},textareaClass:{default:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"},users:{}},emits:["update:modelValue","mention"],setup(k,{emit:s}){const n=k,v=s,e=g(),d=g(n.modelValue),i=g(!1),o=g([]),t=g(0),x=g(0),w=g("");j(()=>n.users,u=>{L.setUsers(u)},{immediate:!0}),j(d,u=>{v("update:modelValue",u);const _=L.extractMentions(u);_.length>0&&v("mention",_)});const C=z(()=>e.value?{position:"absolute",top:`${e.value.getBoundingClientRect().height+4}px`,left:"0px",width:"100%",maxWidth:"350px"}:{}),I=()=>{const u=e.value?.selectionStart||0,m=d.value.substring(0,u).match(/@([^\s@]*)$/u);m?(x.value=u-m[0].length,w.value=m[1],o.value=L.searchUsers(w.value),i.value=o.value.length>0,t.value=0):i.value=!1},D=u=>{if(i.value)switch(u.key){case"ArrowDown":u.preventDefault(),t.value=Math.min(t.value+1,o.value.length-1);break;case"ArrowUp":u.preventDefault(),t.value=Math.max(t.value-1,0);break;case"Enter":u.preventDefault(),o.value[t.value]&&S(o.value[t.value]);break;case"Escape":i.value=!1;break}},V=()=>{},F=()=>{},S=u=>{if(!e.value)return;const _=e.value.selectionStart||0,m=d.value.substring(0,x.value),a=d.value.substring(_),l=`@${u.name}`;d.value=m+l+a;const r=m.length+l.length;O(()=>{e.value&&(e.value.setSelectionRange(r,r),e.value.focus())}),i.value=!1},$=u=>{e.value&&!e.value.contains(u.target)&&(i.value=!1)};return E(()=>{document.addEventListener("click",$)}),Q(()=>{document.removeEventListener("click",$)}),(u,_)=>(f(),h("div",Z,[N(c("textarea",{ref_key:"textarea",ref:e,"onUpdate:modelValue":_[0]||(_[0]=m=>d.value=m),onInput:I,onKeydown:D,onKeyup:V,onClick:F,placeholder:u.placeholder,class:A(u.textareaClass),rows:"3"},null,42,ee),[[R,d.value]]),i.value&&o.value.length>0?(f(),h("div",{key:0,class:"absolute z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto",style:Y(C.value)},[(f(!0),h(T,null,B(o.value,(m,a)=>(f(),h("div",{key:m.id,onClick:l=>S(m),class:A(["px-3 py-2 cursor-pointer flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700",a===t.value?"bg-blue-50 dark:bg-blue-900/20":""])},[m.avatar?(f(),h("div",ae,[c("img",{src:m.avatar,alt:m.name,class:"w-full h-full object-cover"},null,8,se)])):(f(),h("div",oe,[c("span",ne,b(m.name.charAt(0).toUpperCase()),1)])),c("div",null,[c("div",re,b(m.name),1),c("div",le,b(m.email),1)])],10,te))),128))],4)):M("",!0)]))}}),de=G(ie,[["__scopeId","data-v-bc1259de"]]);function ue(){const k=g([]),s=g(!1),n=g(null),v=async()=>{try{s.value=!0,n.value=null;const o=await fetch("/api/users",{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(o.ok){const t=await o.json();k.value=t}else n.value="Failed to load company users"}catch(o){n.value="Failed to load company users",console.error("Failed to load company users:",o)}finally{s.value=!1}},e=o=>k.value.find(t=>t.id===o),d=o=>k.value.find(t=>t.name.toLowerCase().includes(o.toLowerCase())),i=o=>{if(!o)return k.value;const t=o.toLowerCase();return k.value.filter(x=>x.name.toLowerCase().includes(t)||x.email.toLowerCase().includes(t))};return E(()=>{v()}),{users:k,loading:s,error:n,loadUsers:v,getUserById:e,getUserByName:d,searchUsers:i}}const ce={class:"mt-6"},me={class:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3"},ge={class:"flex justify-end"},ve=["disabled"],he={key:0,class:"text-sm text-gray-500"},fe={key:1},pe={key:0,class:"text-sm text-gray-500"},ye={class:"space-y-3"},be=["data-comment-id"],xe={class:"flex items-start justify-between gap-3"},we={class:"flex-1"},ke={class:"mb-1 text-xs text-gray-600 dark:text-gray-400"},_e={class:"font-medium text-gray-800 dark:text-gray-200"},Ce={key:0,class:"flex gap-2"},Ie=["onClick"],Se={key:1,class:"text-sm text-gray-800 dark:text-gray-100 whitespace-pre-line"},$e={class:"flex gap-2"},Ue=["onClick"],Me=["onClick"],Ve=P({__name:"TodoComments",props:{todoId:{}},setup(k){const{t:s}=q(),n=k,e=W().props?.auth?.user||null,d=g(!1),i=g(!1),o=g(""),t=g([]),x=g(null),w=g(""),C=g(null),{users:I}=ue();j(I,a=>{a.length>0&&L.setUsers(a)},{immediate:!0});const D=a=>{console.log("Mentions detected:",a)},V=async()=>{if(n.todoId===0){t.value=[],d.value=!1;return}try{d.value=!0;const a=await U.getComments(n.todoId);t.value=a.sort((p,K)=>new Date(K.created_at).getTime()-new Date(p.created_at).getTime());const r=new URLSearchParams(window.location.search).get("highlight");r&&(C.value=parseInt(r),await O(),setTimeout(()=>{const p=document.querySelector(`[data-comment-id="${r}"]`);p&&p.scrollIntoView({behavior:"smooth",block:"center"})},100),setTimeout(()=>{C.value=null;const p=new URL(window.location.href);p.searchParams.delete("highlight"),window.history.replaceState({},"",p.toString())},5e3))}catch(a){console.error("Failed to load comments",a)}finally{d.value=!1}},F=async()=>{if(o.value.trim()){if(n.todoId===0){const a={id:Date.now(),content:o.value.trim(),user:e?{id:e.id,name:e.name,email:e.email}:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};t.value.unshift(a),o.value="";return}try{i.value=!0;const a=await U.addComment(n.todoId,o.value.trim());!a.user&&e&&(a.user={id:e.id,name:e.name,email:e.email}),t.value.unshift(a),o.value="",window.$notify?.({type:"success",title:"Comment Added",message:"Your comment was added."})}catch(a){console.error("Failed to add comment",a),window.$notify?.({type:"error",title:"Add Failed",message:"Could not add comment."})}finally{i.value=!1}}},S=a=>{x.value=a.id,w.value=a.content},$=()=>{x.value=null,w.value=""},u=async a=>{if(w.value.trim()){if(n.todoId===0){const l=t.value.findIndex(r=>String(r.id)===String(a.id));l!==-1&&(t.value[l].content=w.value.trim(),t.value[l].updated_at=new Date().toISOString(),t.value=[...t.value]),x.value=null,w.value="";return}try{const l=await U.updateComment(n.todoId,a.id,w.value.trim()),r=t.value.findIndex(p=>String(p.id)===String(a.id));r!==-1&&(t.value[r]=l,t.value=[...t.value]),x.value=null,w.value="",window.$notify?.({type:"success",title:"Comment Updated",message:"Your comment was updated."})}catch(l){console.error("Failed to update comment",l),window.$notify?.({type:"error",title:"Update Failed",message:"Could not update comment."})}}},_=async a=>{if(confirm("Delete this comment?")){if(n.todoId===0){t.value=t.value.filter(l=>String(l.id)!==String(a.id));return}try{await U.deleteComment(n.todoId,a.id),t.value=t.value.filter(l=>String(l.id)!==String(a.id)),window.$notify?.({type:"success",title:"Comment Deleted",message:"Your comment was deleted."})}catch(l){console.error("Failed to delete comment",l),window.$notify?.({type:"error",title:"Delete Failed",message:"Could not delete comment."})}}},m=a=>{try{return new Date(a).toLocaleString()}catch{return a}};return E(V),(a,l)=>(f(),h("div",ce,[c("h3",me,b(y(s)("comments.title")),1),c("form",{onSubmit:H(F,["prevent"]),class:"mb-4"},[X(de,{modelValue:o.value,"onUpdate:modelValue":l[0]||(l[0]=r=>o.value=r),users:y(I),placeholder:y(s)("comments.write_comment"),onMention:D,class:"mb-2"},null,8,["modelValue","users","placeholder"]),c("div",ge,[c("button",{type:"submit",disabled:i.value||!o.value.trim(),class:"inline-flex items-center justify-center gap-2 rounded-md px-4 py-2 text-sm font-medium border transition-colors cursor-pointer bg-black text-white hover:bg-gray-900 hover:border-gray-900 dark:bg-white dark:text-black dark:hover:bg-gray-100 dark:hover:border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"},b(i.value?y(s)("comments.adding"):y(s)("comments.add_comment")),9,ve)])],32),d.value?(f(),h("div",he,b(y(s)("comments.loading")),1)):(f(),h("div",fe,[t.value.length===0?(f(),h("div",pe,b(y(s)("comments.no_comments")),1)):M("",!0),c("ul",ye,[(f(!0),h(T,null,B(t.value,r=>(f(),h("li",{key:r.id,"data-comment-id":r.id,class:A(["p-3 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 transition-all duration-300",{"ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-600":C.value===r.id}])},[c("div",xe,[c("div",we,[c("div",ke,[c("span",_e,b(r.user?.name||y(s)("comments.user")),1),l[2]||(l[2]=c("span",{class:"mx-1"},"Â·",-1)),c("span",null,b(m(r.created_at)),1)]),x.value===r.id?(f(),h("div",Ce,[N(c("input",{"onUpdate:modelValue":l[1]||(l[1]=p=>w.value=p),type:"text",class:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"},null,512),[[R,w.value]]),c("button",{onClick:p=>u(r),class:"inline-flex items-center justify-center gap-2 rounded-md px-3 py-2 text-sm font-medium border transition-colors cursor-pointer bg-black text-white hover:bg-gray-900 hover:border-gray-900 dark:bg-white dark:text-black dark:hover:bg-gray-100 dark:hover:border-gray-300"},b(y(s)("common.save")),9,Ie),c("button",{onClick:$,class:"inline-flex items-center justify-center gap-2 rounded-md px-3 py-2 text-sm font-medium border transition-colors cursor-pointer bg-black/30 text-black dark:bg-white/30 dark:text-white"},b(y(s)("common.cancel")),1)])):(f(),h("div",Se,b(r.content),1))]),c("div",$e,[x.value!==r.id&&r.user?.id===y(e)?.id?(f(),h("button",{key:0,onClick:p=>S(r),class:"text-gray-500 hover:text-blue-600 text-sm"},b(y(s)("common.edit")),9,Ue)):M("",!0),r.user?.id===y(e)?.id?(f(),h("button",{key:1,onClick:p=>_(r),class:"text-gray-500 hover:text-red-600 text-sm"},b(y(s)("common.delete")),9,Me)):M("",!0)])])],10,be))),128))])]))]))}});export{Ve as _};
