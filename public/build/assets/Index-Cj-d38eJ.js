import{d as V,K as z,r as R,p as k,o as g,q as n,f as a,A as t,b as s,g as _,t as u,a as y,e as C,i as Z,D as Q,c as F,l as ee,J as te,n as A,F as D,j as U,L as B}from"./app-_byovdp3.js";import{C as oe,c as se,b as ae}from"./AppLayout.vue_vue_type_script_setup_true_lang-tqKoSWuA.js";import{_ as $}from"./index-BsOilCDX.js";import{_ as S,a as P,b as N,c as O,d as X}from"./CardTitle.vue_vue_type_script_setup_true_lang-B4x46iBv.js";import{_ as le,a as ne,b as re,c as ce,d as ie}from"./DialogTitle.vue_vue_type_script_setup_true_lang-SYocMTTK.js";import{_ as ue,a as de}from"./Label.vue_vue_type_script_setup_true_lang-DYGeQ4fs.js";import{C as L}from"./index-BnGfGgKs.js";import{C as q}from"./check-CUOOO1Vr.js";import"./useForwardExpose-ZpkNWAu3.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-D8tlzzwE.js";import"./index-CU7IZpZl.js";const ge={class:"space-y-4 py-4"},pe={class:"space-y-2"},me={key:0,class:"text-sm text-red-600"},fe={class:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3"},_e={class:"text-sm text-blue-600 dark:text-blue-400 mt-1 list-disc list-inside"},be={class:"flex items-center gap-2"},ye=V({__name:"CompanyCreationModal",props:{open:{type:Boolean},targetPlan:{}},emits:["close","success"],setup(I,{emit:b}){const w=I,d=b,l=z({company_name:"",target_plan:w.targetPlan}),f=R(!1),v=()=>{l.company_name.trim()&&(f.value=!0,l.target_plan=w.targetPlan,l.post("/subscription/create-company-and-upgrade",{onSuccess:p=>{const i=p.props.flash;i?.redirect_url?window.location.href=i.redirect_url:(d("success",p.props.company),d("close"))},onError:p=>{console.error("Company creation failed:",p)},onFinish:()=>{f.value=!1}}))},x=()=>{l.reset(),d("close")};return(p,i)=>(g(),k(t(ie),{open:p.open,"onUpdate:open":x},{default:n(()=>[a(t(le),{class:"sm:max-w-md"},{default:n(()=>[a(t(ne),null,{default:n(()=>[a(t(re),{class:"flex items-center gap-2"},{default:n(()=>[a(t(L),{class:"w-5 h-5 text-amber-600"}),i[1]||(i[1]=_(" Company Required ",-1))]),_:1,__:[1]}),a(t(ce),null,{default:n(()=>[_(" To upgrade to a "+u(p.targetPlan)+" plan, you need to create a company. Please enter your company name below. ",1)]),_:1})]),_:1}),s("div",ge,[s("div",pe,[a(t(ue),{for:"company-name"},{default:n(()=>i[2]||(i[2]=[_("Company Name",-1)])),_:1,__:[2]}),a(t(de),{id:"company-name",modelValue:t(l).company_name,"onUpdate:modelValue":i[0]||(i[0]=E=>t(l).company_name=E),placeholder:"Enter your company name",disabled:f.value,onKeydown:Z(v,["enter"])},null,8,["modelValue","disabled"]),t(l).errors.company_name?(g(),y("div",me,u(t(l).errors.company_name),1)):C("",!0)]),s("div",fe,[i[5]||(i[5]=s("p",{class:"text-sm text-blue-700 dark:text-blue-300"},[s("strong",null,"What happens next:")],-1)),s("ul",_e,[i[3]||(i[3]=s("li",null,"We'll create your company profile",-1)),i[4]||(i[4]=s("li",null,"You'll be redirected to Stripe for payment",-1)),s("li",null,"Your account will be upgraded to "+u(p.targetPlan)+" plan",1)])])]),s("div",be,[a(t($),{variant:"outline",onClick:x,disabled:f.value,class:"flex-1"},{default:n(()=>i[6]||(i[6]=[_(" Cancel ",-1)])),_:1,__:[6]},8,["disabled"]),a(t($),{onClick:v,disabled:!t(l).company_name.trim()||f.value,class:"flex-1"},{default:n(()=>[_(u(f.value?"Creating...":`Create Company & Upgrade to ${p.targetPlan}`),1)]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["open"]))}}),ve={class:"max-w-6xl mx-auto p-6"},xe={key:0,class:"mb-6"},he={class:"flex items-center gap-2 text-red-700 dark:text-red-300"},ke={class:"text-sm font-medium"},Ce={class:"flex items-center justify-between"},we={class:"text-lg font-semibold"},Ee={class:"text-gray-600 dark:text-gray-400"},Fe={key:0,class:"mt-2"},Se={class:"text-sm text-gray-500"},Pe={class:"flex items-center gap-2"},Re={class:"mb-8"},$e={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},Ie={class:"text-3xl font-bold text-gray-900 dark:text-gray-100"},Me={class:"text-sm text-gray-500"},Ae={class:"space-y-2 mb-6"},De={key:1,class:"text-center"},He=V({__name:"Index",props:{user:{},company:{},plans:{},stripePublicKey:{}},setup(I){const b=I,w=Q(),d=R(!1),l=F(()=>b.company?.subscription_type||"FREE"),f=F(()=>b.company?.subscription_status==="active"),v=R(!1),x=R(""),p=F(()=>w.props.errors||{}),i=F(()=>{if(l.value==="FREE")return b.plans;const e={...b.plans};return delete e.FREE,e});console.log("=== SUBSCRIPTION PAGE LOADED ==="),console.log("Props:",b),console.log("Current plan computed:",l.value),console.log("Loading state:",d.value),console.log("Component initial setup complete"),console.log("Component fully loaded at:",new Date().toISOString());const E=o=>`Â£${(o/100).toFixed(0)}`,K=o=>o===l.value?o==="MAXI"?"border-2 border-yellow-500 bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20":o==="MIDI"?"border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-2 border-gray-500 bg-gray-50 dark:bg-gray-900/20":"border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600",Y=o=>{const e=l.value,r=b.plans[o],c={FREE:0,MIDI:1,MAXI:2},m=c[e]||0,h=c[o]||0;return h>m?`Upgrade to ${r.name}`:h<m?`Downgrade to ${r.name}`:`Switch to ${r.name}`},j=o=>{console.log("=== BUTTON CLICKED ==="),console.log("Plan type:",o),console.log("Current time:",new Date().toISOString()),console.log("Loading state:",d.value),console.log("Current plan:",l.value),console.log("Function exists:",typeof M),console.log("About to call changePlan...");try{M(o),console.log("changePlan called successfully")}catch(e){console.error("Error calling changePlan:",e)}},M=async o=>{if(console.log("changePlan called with:",o),console.log("loading.value:",d.value),console.log("currentPlan.value:",l.value),d.value||o===l.value){console.log("Exiting early - either loading or same plan");return}d.value=!0,console.log("Setting loading to true, using Inertia router approach..."),B.post("/subscription/change-plan",{plan:o},{onBefore:()=>(console.log("Inertia request starting..."),!0),onSuccess:e=>{console.log("Inertia request successful:",e),console.log("Full page props:",JSON.stringify(e.props,null,2)),console.log("All page props keys:",Object.keys(e.props)),console.log("Direct redirect_url check:",e.props.redirect_url),console.log("Has redirect_url prop:","redirect_url"in e.props);const r=e.props.flash;console.log("Flash data:",r),console.log("Flash type:",typeof r),console.log("Flash keys:",r?Object.keys(r):"no flash");let c=null;if(r?.redirect_url)c=r.redirect_url,console.log("Found redirect_url in flash.redirect_url");else if(e.props.redirect_url)c=e.props.redirect_url,console.log("Found redirect_url in page.props.redirect_url");else if(r&&typeof r=="object"){for(const[m,h]of Object.entries(r))if(console.log(`Flash ${m}:`,h),m==="redirect_url"||typeof h=="string"&&h.includes("checkout.stripe.com")){c=h,console.log(`Found redirect URL in flash.${m}`);break}}c?(console.log("Redirecting to Stripe checkout:",c),window.location.href=c):(console.log("No redirect URL found, handling plan change"),(l.value==="MAXI"&&o==="MIDI"||l.value!=="FREE"&&o==="FREE")&&(console.log("Downgrade detected, emitting project reload event"),window.dispatchEvent(new CustomEvent("subscription-downgrade",{detail:{newPlan:o,oldPlan:l.value}}))),window.location.reload())},onError:e=>{if(console.error("Inertia request failed:",e),console.log("Error details:",JSON.stringify(e,null,2)),e.plan&&e.plan.includes("No company found")){console.log("No company found error detected, showing company creation modal"),x.value=o,v.value=!0;return}let r="An error occurred while changing your plan. Please try again.";e.plan?r=e.plan:e.message&&(r=e.message),alert(r)},onFinish:()=>{console.log("Setting loading to false"),d.value=!1}})},H=()=>{const o=document.querySelector('meta[name="csrf-token"]');return o?o.getAttribute("content"):""},J=async()=>{console.log("=== TESTING CSRF ===");const o=H();console.log("CSRF Token:",o?"Found":"Missing");try{const e=await fetch("/subscription/test-csrf",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(console.log("CSRF Test Response:",e.status,e.statusText),e.ok){const r=await e.json();console.log("CSRF Test Success:",r)}else console.log("CSRF Test Failed:",e.status)}catch(e){console.error("CSRF Test Error:",e)}};ee(()=>{console.log("=== COMPONENT MOUNTED ==="),console.log("onMounted hook called at:",new Date().toISOString()),console.log("Final function check:",{handlePlanChange:typeof j,changePlan:typeof M}),console.log("Running automatic CSRF test..."),J()});const T=async()=>{confirm("Are you sure you want to cancel your subscription? Your account will be downgraded to the FREE plan.")&&(d.value=!0,B.post("/subscription/cancel-subscription",{},{onSuccess:()=>{},onError:o=>{console.error("Error cancelling subscription:",o),alert("An error occurred while cancelling your subscription. Please try again.")},onFinish:()=>{d.value=!1}}))},W=()=>{v.value=!1,x.value=""},G=o=>{console.log("Company created successfully:",o),v.value=!1,x.value=""};return(o,e)=>(g(),y(D,null,[a(t(te),{title:"Subscription Management"}),a(ae,null,{default:n(()=>[s("div",ve,[e[7]||(e[7]=s("div",{class:"mb-8"},[s("h1",{class:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2"}," Subscription Management "),s("p",{class:"text-gray-600 dark:text-gray-400"}," Manage your TaskIT subscription and billing settings ")],-1)),p.value.subscription?(g(),y("div",xe,[a(t(S),{class:"border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20"},{default:n(()=>[a(t(P),{class:"p-4"},{default:n(()=>[s("div",he,[a(t(L),{class:"w-5 h-5 flex-shrink-0"}),s("p",ke,u(p.value.subscription),1)])]),_:1})]),_:1})])):C("",!0),a(t(S),{class:"mb-8"},{default:n(()=>[a(t(N),null,{default:n(()=>[a(t(O),{class:"flex items-center gap-2"},{default:n(()=>[a(t(oe),{class:"w-5 h-5"}),e[0]||(e[0]=_(" Current Subscription ",-1))]),_:1,__:[0]})]),_:1}),a(t(P),null,{default:n(()=>[s("div",Ce,[s("div",null,[s("p",we,u(o.plans[l.value].name),1),s("p",Ee,u(l.value==="FREE"?"Free forever":`${E(o.plans[l.value].price)} per month`),1),o.company?.subscription_ends_at?(g(),y("div",Fe,[s("p",Se,u(f.value?"Renews on":"Expires on")+": "+u(new Date(o.company.subscription_ends_at).toLocaleDateString()),1)])):C("",!0)]),s("div",Pe,[s("div",{class:A(["px-3 py-1 rounded-full text-sm font-medium",{"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300":f.value,"bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300":o.company?.subscription_status==="past_due","bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300":o.company?.subscription_status==="canceled","bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300":l.value==="FREE"}])},u(f.value?"Active":o.company?.subscription_status||"Free"),3)])])]),_:1})]),_:1}),s("div",Re,[e[2]||(e[2]=s("h2",{class:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6"}," Available Plans ",-1)),s("div",$e,[(g(!0),y(D,null,U(i.value,(r,c)=>(g(),k(t(S),{key:c,class:A(K(c))},{default:n(()=>[a(t(N),{class:"text-center"},{default:n(()=>[a(t(O),{class:"flex items-center justify-center gap-2"},{default:n(()=>[c==="MAXI"?(g(),k(t(se),{key:0,class:"w-5 h-5 text-yellow-500"})):C("",!0),s("span",{class:A({"text-yellow-600 dark:text-yellow-400":c==="MAXI"})},u(r.name),3),c===l.value?(g(),k(t(q),{key:1,class:"w-5 h-5 text-green-500"})):C("",!0)]),_:2},1024),a(t(X),null,{default:n(()=>[s("div",Ie,u(c==="FREE"?"Free":E(r.price)),1),s("div",Me,u(c==="FREE"?"Forever":"per month"),1)]),_:2},1024)]),_:2},1024),a(t(P),null,{default:n(()=>[s("ul",Ae,[(g(!0),y(D,null,U(r.features,m=>(g(),y("li",{key:m,class:"flex items-start gap-2 text-sm"},[a(t(q),{class:"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"}),s("span",null,u(m),1)]))),128))]),c!==l.value?(g(),k(t($),{key:0,onClick:m=>j(c),disabled:d.value,variant:c==="MIDI"||c==="MAXI"?"default":"outline",class:"w-full"},{default:n(()=>[_(u(Y(c)),1)]),_:2},1032,["onClick","disabled","variant"])):(g(),y("div",De,e[1]||(e[1]=[s("span",{class:"text-sm text-gray-500"},"Current Plan",-1)])))]),_:2},1024)]),_:2},1032,["class"]))),128))])]),l.value!=="FREE"&&o.company?.stripe_subscription_id?(g(),k(t(S),{key:1,class:"border-red-200 dark:border-red-800"},{default:n(()=>[a(t(N),null,{default:n(()=>[a(t(O),{class:"flex items-center gap-2 text-red-600 dark:text-red-400"},{default:n(()=>[a(t(L),{class:"w-5 h-5"}),e[3]||(e[3]=_(" Danger Zone ",-1))]),_:1,__:[3]}),a(t(X),null,{default:n(()=>e[4]||(e[4]=[_(" Cancel your subscription and downgrade to the FREE plan ",-1)])),_:1,__:[4]})]),_:1}),a(t(P),null,{default:n(()=>[a(t($),{onClick:T,disabled:d.value,variant:"destructive"},{default:n(()=>e[5]||(e[5]=[_(" Cancel Subscription ",-1)])),_:1,__:[5]},8,["disabled"]),e[6]||(e[6]=s("p",{class:"text-xs text-gray-500 mt-2"}," Your subscription will remain active until the end of your current billing period. ",-1))]),_:1,__:[6]})]),_:1})):C("",!0)]),a(ye,{open:v.value,"target-plan":x.value,onClose:W,onSuccess:G},null,8,["open","target-plan"])]),_:1})],64))}});export{He as default};
