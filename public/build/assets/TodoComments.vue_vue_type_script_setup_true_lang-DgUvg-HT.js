import{r as v,d as N,P as A,A as z,D as P,I as Q,c as h,o as f,g as R,i as M,v as T,e as c,n as E,m as Y,F as j,k as B,x as O,t as b,B as q,E as W,b as y,a as X,f as H}from"./app-CsUDC1zp.js";import{a as G,t as U}from"./realtimeService-B_rssAg_.js";class J{users=v([]);currentMentions=v([]);getUsers(){return this.users.value}setUsers(a){this.users.value=a}searchUsers(a){if(!a)return this.users.value;const o=a.toLowerCase();return this.users.value.filter(g=>g.name.toLowerCase().includes(o)||g.email.toLowerCase().includes(o))}parseMentions(a){const o=[],g=/@([^\s@]+)/gu;let e;for(;(e=g.exec(a))!==null;){const d=e[1],i=this.users.value.find(n=>n.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());i&&o.push({id:`${i.id}-${e.index}`,userId:i.id,userName:i.name,position:e.index,length:e[0].length})}return o}getSuggestions(a,o){const e=a.substring(0,o).match(/@([^\s@]*)$/u);if(!e)return[];const d=e[1];return this.searchUsers(d)}isInMention(a,o){const g=a.substring(0,o);return/@[^\s@]*$/u.test(g)}formatMentions(a){return a.replace(/@([^\s@]+)/gu,(o,g)=>{const e=this.users.value.find(d=>d.name.toLowerCase().replace(/\s+/g,"")===g.toLowerCase());return e?`<span class="mention" data-user-id="${e.id}">@${e.name}</span>`:o})}extractMentions(a){const o=[],g=/@([^\s@]+)/gu;let e;for(;(e=g.exec(a))!==null;){const d=e[1],i=this.users.value.find(n=>n.name.toLowerCase().replace(/\s+/g,"")===d.toLowerCase());i&&o.push({userId:i.id,userName:i.name})}return o}}const L=new J,Z={class:"relative"},ee=["placeholder"],te=["onClick"],se={key:0,class:"w-6 h-6 rounded-full overflow-hidden"},ae=["src","alt"],ne={key:1,class:"w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center"},oe={class:"text-xs font-medium text-gray-600 dark:text-gray-300"},re={class:"text-sm font-medium text-gray-900 dark:text-gray-100"},le={class:"text-xs text-gray-500 dark:text-gray-400"},ie=N({__name:"MentionInput",props:{modelValue:{},placeholder:{default:"Add a comment..."},textareaClass:{default:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"},users:{}},emits:["update:modelValue","mention"],setup(_,{emit:a}){const o=_,g=a,e=v(),d=v(o.modelValue),i=v(!1),n=v([]),t=v(0),w=v(0),x=v("");A(()=>o.users,u=>{L.setUsers(u)},{immediate:!0}),A(d,u=>{g("update:modelValue",u);const k=L.extractMentions(u);k.length>0&&g("mention",k)});const C=z(()=>e.value?{position:"absolute",top:`${e.value.getBoundingClientRect().height+4}px`,left:"0px",width:"100%",maxWidth:"350px"}:{}),I=()=>{const u=e.value?.selectionStart||0,m=d.value.substring(0,u).match(/@([^\s@]*)$/u);m?(w.value=u-m[0].length,x.value=m[1],n.value=L.searchUsers(x.value),i.value=n.value.length>0,t.value=0):i.value=!1},D=u=>{if(i.value)switch(u.key){case"ArrowDown":u.preventDefault(),t.value=Math.min(t.value+1,n.value.length-1);break;case"ArrowUp":u.preventDefault(),t.value=Math.max(t.value-1,0);break;case"Enter":u.preventDefault(),n.value[t.value]&&S(n.value[t.value]);break;case"Escape":i.value=!1;break}},V=()=>{},F=()=>{},S=u=>{if(!e.value)return;const k=e.value.selectionStart||0,m=d.value.substring(0,w.value),s=d.value.substring(k),l=`@${u.name}`;d.value=m+l+s;const r=m.length+l.length;O(()=>{e.value&&(e.value.setSelectionRange(r,r),e.value.focus())}),i.value=!1},$=u=>{e.value&&!e.value.contains(u.target)&&(i.value=!1)};return P(()=>{document.addEventListener("click",$)}),Q(()=>{document.removeEventListener("click",$)}),(u,k)=>(f(),h("div",Z,[R(c("textarea",{ref_key:"textarea",ref:e,"onUpdate:modelValue":k[0]||(k[0]=m=>d.value=m),onInput:I,onKeydown:D,onKeyup:V,onClick:F,placeholder:u.placeholder,class:E(u.textareaClass),rows:"3"},null,42,ee),[[T,d.value]]),i.value&&n.value.length>0?(f(),h("div",{key:0,class:"absolute z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto",style:Y(C.value)},[(f(!0),h(j,null,B(n.value,(m,s)=>(f(),h("div",{key:m.id,onClick:l=>S(m),class:E(["px-3 py-2 cursor-pointer flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700",s===t.value?"bg-blue-50 dark:bg-blue-900/20":""])},[m.avatar?(f(),h("div",se,[c("img",{src:m.avatar,alt:m.name,class:"w-full h-full object-cover"},null,8,ae)])):(f(),h("div",ne,[c("span",oe,b(m.name.charAt(0).toUpperCase()),1)])),c("div",null,[c("div",re,b(m.name),1),c("div",le,b(m.email),1)])],10,te))),128))],4)):M("",!0)]))}}),de=G(ie,[["__scopeId","data-v-bc1259de"]]);function ue(){const _=v([]),a=v(!1),o=v(null),g=async()=>{try{a.value=!0,o.value=null;const n=await fetch("/api/users",{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(n.ok){const t=await n.json();_.value=t}else o.value="Failed to load company users"}catch(n){o.value="Failed to load company users",console.error("Failed to load company users:",n)}finally{a.value=!1}},e=n=>_.value.find(t=>t.id===n),d=n=>_.value.find(t=>t.name.toLowerCase().includes(n.toLowerCase())),i=n=>{if(!n)return _.value;const t=n.toLowerCase();return _.value.filter(w=>w.name.toLowerCase().includes(t)||w.email.toLowerCase().includes(t))};return P(()=>{g()}),{users:_,loading:a,error:o,loadUsers:g,getUserById:e,getUserByName:d,searchUsers:i}}const ce={class:"mt-6"},me={class:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3"},ve={class:"flex justify-end"},ge=["disabled"],he={key:0,class:"text-sm text-gray-500"},fe={key:1},pe={key:0,class:"text-sm text-gray-500"},ye={class:"space-y-3"},be=["data-comment-id"],we={class:"flex items-start justify-between gap-3"},xe={class:"flex-1"},_e={class:"mb-1 text-xs text-gray-600 dark:text-gray-400"},ke={class:"font-medium text-gray-800 dark:text-gray-200"},Ce={key:0,class:"flex gap-2"},Ie=["onClick"],Se={key:1,class:"text-sm text-gray-800 dark:text-gray-100 whitespace-pre-line"},$e={class:"flex gap-2"},Ue=["onClick"],Me=["onClick"],Ve=N({__name:"TodoComments",props:{todoId:{}},setup(_){const{t:a}=q(),o=_,e=W().props?.auth?.user||null,d=v(!1),i=v(!1),n=v(""),t=v([]),w=v(null),x=v(""),C=v(null),{users:I}=ue();A(I,s=>{s.length>0&&L.setUsers(s)},{immediate:!0});const D=s=>{console.log("Mentions detected:",s)},V=async()=>{if(o.todoId===0){t.value=[],d.value=!1;return}try{d.value=!0;const s=await U.getComments(o.todoId);t.value=s.sort((p,K)=>new Date(K.created_at).getTime()-new Date(p.created_at).getTime());const r=new URLSearchParams(window.location.search).get("highlight");r&&(C.value=parseInt(r),await O(),setTimeout(()=>{const p=document.querySelector(`[data-comment-id="${r}"]`);p&&p.scrollIntoView({behavior:"smooth",block:"center"})},100),setTimeout(()=>{C.value=null;const p=new URL(window.location.href);p.searchParams.delete("highlight"),window.history.replaceState({},"",p.toString())},5e3))}catch(s){console.error("Failed to load comments",s)}finally{d.value=!1}},F=async()=>{if(n.value.trim()){if(o.todoId===0){const s={id:Date.now(),content:n.value.trim(),user:e?{id:e.id,name:e.name,email:e.email}:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};t.value.unshift(s),n.value="";return}try{i.value=!0;const s=await U.addComment(o.todoId,n.value.trim());!s.user&&e&&(s.user={id:e.id,name:e.name,email:e.email}),t.value.unshift(s),n.value="",window.$notify?.({type:"success",title:"Comment Added",message:"Your comment was added."})}catch(s){console.error("Failed to add comment",s),window.$notify?.({type:"error",title:"Add Failed",message:"Could not add comment."})}finally{i.value=!1}}},S=s=>{w.value=s.id,x.value=s.content},$=()=>{w.value=null,x.value=""},u=async s=>{if(x.value.trim()){if(o.todoId===0){const l=t.value.findIndex(r=>String(r.id)===String(s.id));l!==-1&&(t.value[l].content=x.value.trim(),t.value[l].updated_at=new Date().toISOString(),t.value=[...t.value]),w.value=null,x.value="";return}try{const l=await U.updateComment(o.todoId,s.id,x.value.trim()),r=t.value.findIndex(p=>String(p.id)===String(s.id));r!==-1&&(t.value[r]=l,t.value=[...t.value]),w.value=null,x.value="",window.$notify?.({type:"success",title:"Comment Updated",message:"Your comment was updated."})}catch(l){console.error("Failed to update comment",l),window.$notify?.({type:"error",title:"Update Failed",message:"Could not update comment."})}}},k=async s=>{if(confirm("Delete this comment?")){if(o.todoId===0){t.value=t.value.filter(l=>String(l.id)!==String(s.id));return}try{await U.deleteComment(o.todoId,s.id),t.value=t.value.filter(l=>String(l.id)!==String(s.id)),window.$notify?.({type:"success",title:"Comment Deleted",message:"Your comment was deleted."})}catch(l){console.error("Failed to delete comment",l),window.$notify?.({type:"error",title:"Delete Failed",message:"Could not delete comment."})}}},m=s=>{try{return new Date(s).toLocaleString()}catch{return s}};return P(V),(s,l)=>(f(),h("div",ce,[c("h3",me,b(y(a)("comments.title")),1),c("form",{onSubmit:H(F,["prevent"]),class:"mb-4"},[X(de,{modelValue:n.value,"onUpdate:modelValue":l[0]||(l[0]=r=>n.value=r),users:y(I),placeholder:y(a)("comments.write_comment"),onMention:D,class:"mb-2"},null,8,["modelValue","users","placeholder"]),c("div",ve,[c("button",{type:"submit",disabled:i.value||!n.value.trim(),class:"px-4 py-2 bg-blue-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"},b(i.value?y(a)("comments.adding"):y(a)("comments.add_comment")),9,ge)])],32),d.value?(f(),h("div",he,b(y(a)("comments.loading")),1)):(f(),h("div",fe,[t.value.length===0?(f(),h("div",pe,b(y(a)("comments.no_comments")),1)):M("",!0),c("ul",ye,[(f(!0),h(j,null,B(t.value,r=>(f(),h("li",{key:r.id,"data-comment-id":r.id,class:E(["p-3 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 transition-all duration-300",{"ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-600":C.value===r.id}])},[c("div",we,[c("div",xe,[c("div",_e,[c("span",ke,b(r.user?.name||y(a)("comments.user")),1),l[2]||(l[2]=c("span",{class:"mx-1"},"·",-1)),c("span",null,b(m(r.created_at)),1)]),w.value===r.id?(f(),h("div",Ce,[R(c("input",{"onUpdate:modelValue":l[1]||(l[1]=p=>x.value=p),type:"text",class:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"},null,512),[[T,x.value]]),c("button",{onClick:p=>u(r),class:"px-3 py-2 bg-green-600 text-white rounded-md"},b(y(a)("common.save")),9,Ie),c("button",{onClick:$,class:"px-3 py-2 bg-gray-300 text-gray-800 rounded-md"},b(y(a)("common.cancel")),1)])):(f(),h("div",Se,b(r.content),1))]),c("div",$e,[w.value!==r.id&&r.user?.id===y(e)?.id?(f(),h("button",{key:0,onClick:p=>S(r),class:"text-gray-500 hover:text-blue-600 text-sm"},b(y(a)("common.edit")),9,Ue)):M("",!0),r.user?.id===y(e)?.id?(f(),h("button",{key:1,onClick:p=>k(r),class:"text-gray-500 hover:text-red-600 text-sm"},b(y(a)("common.delete")),9,Me)):M("",!0)])])],10,be))),128))])]))]))}});export{Ve as _};
